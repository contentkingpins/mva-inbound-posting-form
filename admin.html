<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Claim Connectors</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    
    <!-- Preconnect to CDNs -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://unpkg.com/lucide@latest/dist/lucide.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <!-- CountUp.js for number animations -->
    <script src="https://unpkg.com/countup.js@2.8.0/dist/countUp.umd.js"></script>
    
    <!-- JSZip for creating downloadable publisher packages -->
    <script src="critical-functions.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- jsPDF for generating PDF instructions -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- MASTER DARK THEME - Single source of truth -->
    <!-- <link rel="stylesheet" href="css/master-dark-theme.css"> -->
    
    <!-- FALLBACK: Inline critical dark theme styles for instant loading -->
    <style>
    /* Critical dark theme styles - loads immediately */
    :root {
        --bg-primary: #0F0F23;
        --bg-secondary: #1A1A2E;
        --bg-accent: #16213E;
        --bg-glass: rgba(26, 26, 46, 0.95);
        --text-primary: #FFFFFF;
        --text-secondary: #CBD5E1;
        --text-muted: #9CA3AF;
        --accent-blue: #3B82F6;
        --accent-purple: #8B5CF6;
        --success: #10B981;
        --warning: #F59E0B;
        --error: #EF4444;
        --border-subtle: rgba(139, 92, 246, 0.2);
        --border-accent: rgba(59, 130, 246, 0.3);
        --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        --space-4: 1rem;
        --space-6: 1.5rem;
        --radius-md: 0.5rem;
        --radius-lg: 0.75rem;
        --radius-xl: 1rem;
        --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5);
        --transition-base: 0.3s ease;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
        font-family: var(--font-family);
        background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
        color: var(--text-primary);
        min-height: 100vh;
        line-height: 1.6;
    }
    
    .admin-header {
        background: var(--bg-glass);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--border-subtle);
        padding: var(--space-4) var(--space-6);
        position: sticky;
        top: 0;
        z-index: 100;
    }
    
    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .header-title {
        color: var(--accent-purple);
        font-size: 1.5rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .admin-main {
        max-width: 1400px;
        margin: 0 auto;
        padding: var(--space-6);
        min-height: calc(100vh - 80px);
    }
    
    .quick-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.25rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: var(--bg-glass);
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        padding: 1.25rem;
        transition: all var(--transition-base);
        position: relative;
        overflow: hidden;
    }

    .stat-card:hover {
        border-color: var(--accent-purple);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(139, 92, 246, 0.2);
    }

    .stat-icon {
        font-size: 2rem;
        margin-bottom: 1rem;
        color: var(--accent-purple);
    }

    .stat-content {
        flex: 1;
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--text-primary);
        line-height: 1;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
        margin-bottom: 0.75rem;
    }

    .stat-change {
        font-size: 0.75rem;
        font-weight: 500;
        padding: 0.25rem 0.5rem;
        border-radius: var(--radius-md);
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
        display: inline-block;
        margin-bottom: 1rem;
    }

    .stat-change.positive {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
    }

    .stat-change.negative {
        background: rgba(239, 68, 68, 0.1);
        color: var(--error);
    }

    .stat-expand {
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 32px;
        height: 32px;
        background: rgba(139, 92, 246, 0.1);
        border: 1px solid rgba(139, 92, 246, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--accent-purple);
        font-size: 0.875rem;
        cursor: pointer;
        transition: all var(--transition-base);
    }

    .stat-expand:hover {
        background: var(--accent-purple);
        color: white;
        transform: scale(1.1);
    }

    .stat-visual,
    .stat-sparkline,
    .revenue-forecast-mini {
        margin-top: 1rem;
        height: 40px;
        position: relative;
    }

    .agent-performance-mini {
        display: flex;
        gap: 2px;
        align-items: end;
        height: 30px;
        margin-top: 0.5rem;
    }

    .agent-bar {
        width: 8px;
        background: linear-gradient(to top, var(--accent-purple), var(--accent-blue));
        border-radius: 2px;
        height: calc(var(--height) * 0.3);
        transition: all var(--transition-base);
    }

    .conversion-visual {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 1rem;
    }

    .progress-ring {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: conic-gradient(var(--accent-purple) calc(var(--progress) * 1%), rgba(139, 92, 246, 0.1) 0);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

    .progress-ring::before {
        content: attr(data-percent);
        position: absolute;
        font-size: 0.75rem;
        font-weight: 700;
        color: var(--text-primary);
    }
    
    .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        border: none;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all var(--transition-base);
        text-decoration: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .btn-primary {
        background: linear-gradient(135deg, var(--accent-blue), #2563EB);
        color: white;
        border: 1px solid var(--accent-blue);
    }
    
    .btn-primary:hover {
        background: linear-gradient(135deg, #2563EB, #1D4ED8);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    
    .btn-secondary {
        background: linear-gradient(135deg, var(--bg-accent), var(--bg-secondary));
        color: var(--text-primary);
        border: 1px solid var(--border-accent);
    }
    
    .btn-secondary:hover {
        background: linear-gradient(135deg, var(--bg-secondary), var(--bg-accent));
        border-color: var(--accent-purple);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }
    
    .btn-success {
        background: linear-gradient(135deg, var(--success), #059669);
        color: white;
        border: 1px solid var(--success);
    }
    
    .btn-success:hover {
        background: linear-gradient(135deg, #059669, #047857);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }
    
    .btn-info {
        background: linear-gradient(135deg, #3B82F6, #2563EB);
        color: white;
        border: 1px solid #3B82F6;
    }
    
    .btn-info:hover {
        background: linear-gradient(135deg, #2563EB, #1D4ED8);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    
    .btn-warning {
        background: linear-gradient(135deg, var(--warning), #D97706);
        color: white;
        border: 1px solid var(--warning);
    }
    
    .btn-warning:hover {
        background: linear-gradient(135deg, #D97706, #B45309);
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
    }
    
    .btn-outline {
        background: transparent;
        border: 2px solid var(--accent-blue);
        color: var(--accent-blue);
        padding: 0.75rem 1.5rem;
        border-radius: var(--radius-md);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        cursor: pointer;
        transition: all var(--transition-base);
        width: 100%;
        justify-content: center;
        position: relative;
        overflow: hidden;
    }
    
    .btn-outline::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
        transition: left 0.5s ease;
    }
    
    .btn-outline:hover {
        background: var(--accent-blue);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
    }
    
    .btn-outline:hover::before {
        left: 100%;
    }
    
    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
        font-weight: 600;
        white-space: nowrap;
    }

    /* GLOBAL HELPER FUNCTIONS & FIXES */
    .btn-info {
        background: #3B82F6 !important;
        color: white;
        border: none;
    }

    .btn-info:hover {
        background: #2563EB !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    /* ENSURE MODALS WORK PROPERLY */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        z-index: 10000;
        align-items: center;
        justify-content: center;
    }

    .modal-overlay.active {
        display: flex !important;
    }

    .glass-modal {
        background: var(--bg-glass);
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        padding: 2rem 2rem 1rem;
        border-bottom: 1px solid var(--border-subtle);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        color: var(--text-primary);
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        color: var(--text-muted);
        font-size: 2rem;
        cursor: pointer;
        padding: 0;
        line-height: 1;
        transition: color var(--transition-base);
    }

    .modal-close:hover {
        color: var(--text-primary);
    }

    .modal-body {
        padding: 2rem;
    }

    .modal-footer {
        padding: 1rem 2rem 2rem;
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    /* RESPONSIVE MODAL */
    @media (max-width: 768px) {
        .glass-modal {
            width: 95%;
            margin: 1rem;
        }
        
        .modal-header,
        .modal-body,
        .modal-footer {
            padding: 1.5rem;
        }
        
        .modal-footer {
            flex-direction: column;
        }
        
        .modal-footer .btn {
            width: 100%;
        }
    }

    /* ACTIVITY FEED IMPROVEMENTS */
    .activity-feed {
        padding: 1.5rem 2rem 2rem;
        max-height: 400px;
        overflow-y: auto;
    }

    .activity-item {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 1rem;
        margin-bottom: 1rem;
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        border-left: 3px solid var(--accent-purple);
        transition: all var(--transition-base);
        cursor: pointer;
        position: relative;
    }

    .activity-item:hover {
        background: var(--bg-accent);
        transform: translateX(4px);
    }

    .activity-icon {
        width: 40px;
        height: 40px;
        background: rgba(139, 92, 246, 0.1);
        border: 2px solid rgba(139, 92, 246, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.125rem;
        flex-shrink: 0;
    }

    .activity-content {
        flex: 1;
    }

    .activity-text {
        color: var(--text-primary);
        font-size: 0.9rem;
        font-weight: 500;
        margin-bottom: 0.25rem;
    }

    .activity-time {
        color: var(--text-muted);
        font-size: 0.75rem;
        font-weight: 500;
    }

    .activity-expand {
        width: 24px;
        height: 24px;
        background: var(--accent-purple);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1rem;
        font-weight: 700;
        flex-shrink: 0;
        transition: all var(--transition-base);
    }

    .activity-item.expanded .activity-expand {
        background: var(--accent-blue);
        transform: rotate(45deg);
    }

    .activity-details {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--bg-accent);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        padding: 1rem;
        margin-top: 0.5rem;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all var(--transition-base);
        z-index: 10;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }

    .activity-item.expanded .activity-details {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .activity-details p {
        color: var(--text-secondary);
        font-size: 0.875rem;
        line-height: 1.5;
        margin: 0;
    }

    /* FORM STYLES - CRITICAL MISSING STYLES */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        color: var(--text-primary);
        font-size: 0.875rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .form-input {
        width: 100%;
        padding: 0.75rem 1rem;
        background: var(--bg-secondary);
        border: 2px solid var(--border-subtle);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: 0.875rem;
        font-family: var(--font-family);
        transition: all var(--transition-base);
    }

    .form-input:focus {
        outline: none;
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        background: var(--bg-accent);
    }

    .form-input::placeholder {
        color: var(--text-muted);
    }

    .form-input:disabled,
    .form-input[readonly] {
        background: var(--bg-accent);
        color: var(--text-muted);
        cursor: not-allowed;
    }

    select.form-input {
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23CBD5E1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 1rem;
        padding-right: 2.5rem;
        appearance: none;
        cursor: pointer;
    }

    /* ADMIN SECTION STYLES - MISSING ESSENTIAL LAYOUTS */
    .admin-section {
        background: var(--bg-glass);
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        padding: 2rem;
        margin-bottom: 2rem;
        transition: all var(--transition-base);
    }

    .admin-section:hover {
        border-color: var(--accent-purple);
        box-shadow: 0 8px 20px rgba(139, 92, 246, 0.1);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .section-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex: 1;
    }

    .section-title h2 {
        color: var(--text-primary);
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
    }

    .section-icon {
        font-size: 1.5rem;
        color: var(--accent-purple);
    }

    .section-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .ai-badge {
        background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* GRID LAYOUTS */
    .admin-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .overview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
    }

    .ai-insights-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
    }

    /* CARD STYLES */
    .overview-card,
    .analytics-card,
    .ai-insight-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        transition: all var(--transition-base);
    }

    .overview-card:hover,
    .analytics-card:hover,
    .ai-insight-card:hover {
        border-color: var(--accent-blue);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(59, 130, 246, 0.2);
    }

    .overview-card h3,
    .analytics-card h4 {
        color: var(--text-primary);
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* FAB STYLES - MISSING FLOATING ACTION BUTTON */
    .fab-container {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        z-index: 1000;
    }

    .fab {
        width: 56px;
        height: 56px;
        background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
        border: none;
        border-radius: 50%;
        box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        transition: all var(--transition-base);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .fab:hover {
        transform: scale(1.1);
        box-shadow: 0 12px 30px rgba(139, 92, 246, 0.6);
    }

    .fab-menu {
        position: absolute;
        bottom: 70px;
        right: 0;
        background: var(--bg-glass);
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        padding: 1rem;
        opacity: 0;
        visibility: hidden;
        transform: translateY(10px);
        transition: all var(--transition-base);
        min-width: 200px;
    }

    .fab-container.active .fab-menu {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .fab-action {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        width: 100%;
        padding: 0.75rem;
        background: transparent;
        border: none;
        color: var(--text-primary);
        font-size: 0.875rem;
        cursor: pointer;
        border-radius: var(--radius-md);
        transition: all var(--transition-base);
        text-align: left;
    }

    .fab-action:hover {
        background: var(--bg-secondary);
        color: var(--accent-blue);
    }

    /* MANAGEMENT ACTIONS */
    .management-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .action-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        padding: 1.5rem;
        background: var(--bg-secondary);
        border: 2px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        color: var(--text-primary);
        text-decoration: none;
        transition: all var(--transition-base);
        cursor: pointer;
    }

    .action-btn:hover {
        border-color: var(--accent-blue);
        background: var(--bg-accent);
        transform: translateY(-2px);
    }

    .btn-icon {
        font-size: 2rem;
        color: var(--accent-purple);
    }

    .btn-text {
        font-weight: 600;
        text-align: center;
    }

    /* RESPONSIVE DESIGN */
    @media (max-width: 768px) {
        .admin-grid {
            grid-template-columns: 1fr;
        }
        
        .header-content {
            flex-direction: column;
            gap: 1rem;
        }
        
        .header-right {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
        }
        
        .section-header {
            flex-direction: column;
            align-items: stretch;
        }
        
        .fab-container {
            bottom: 1rem;
            right: 1rem;
        }
    }

    /* Action button styles for publisher table */
    .action-btn {
        padding: 0.4rem 0.8rem;
        border: none;
        border-radius: 4px;
        font-size: 0.8rem;
        cursor: pointer;
        margin: 0 2px;
        transition: all 0.2s ease;
    }

    .action-btn.edit {
        background: #3B82F6;
        color: white;
    }

    .action-btn.edit:hover {
        background: #2563EB;
    }

    .action-btn.pdf {
        background: #059669;
        color: white;
    }

    .action-btn.pdf:hover {
        background: #047857;
        transform: translateY(-1px);
    }

    .action-btn.api {
        background: #F59E0B;
        color: white;
    }

    .action-btn.api:hover {
        background: #D97706;
    }

    .action-btn.delete {
        background: #EF4444;
        color: white;
    }

    .action-btn.delete:hover {
        background: #DC2626;
    }

    /* Bulk actions modal styles */
    .bulk-actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin: 1rem 0;
    }

    .bulk-action-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        padding: 1.5rem;
        background: var(--bg-secondary);
        border: 2px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        color: var(--text-primary);
        cursor: pointer;
        transition: all var(--transition-base);
        font-size: 0.9rem;
        font-weight: 600;
    }

    .bulk-action-btn:hover {
        border-color: var(--accent-blue);
        background: var(--bg-accent);
        transform: translateY(-2px);
    }

    /* GLOBAL HELPER FUNCTIONS & FIXES */
    </style>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Build-Time Injected Configuration -->
    <script>
    window.APP_CONFIG = {
        "userPoolId": "us-east-1_lhc964tLD",
        "clientId": "5t6mane4fnvineksoqb4ta0iu1",
        "apiEndpoint": "https://9qtb4my1ij.execute-api.us-east-1.amazonaws.com/prod",
        "apiUrl": "https://9qtb4my1ij.execute-api.us-east-1.amazonaws.com/prod",
        "apiKey": "",
        "buildTime": "2025-05-29T01:13:52.266Z",
        "buildEnv": "production"
    };
    window.preloadedConfig = window.APP_CONFIG;
    console.log('🔧 Configuration injected at build time - no external loading needed');
    
    // 🎨 DARK THEME ENFORCER - Ensures dark theme always loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🎨 Dark Theme Enforcer - Checking CSS...');
        
        // Test if external CSS loaded by checking for custom properties
        const testElement = document.createElement('div');
        testElement.style.display = 'none';
        document.body.appendChild(testElement);
        
        const computedStyle = getComputedStyle(testElement);
        const bgPrimary = computedStyle.getPropertyValue('--bg-primary');
        
        if (!bgPrimary || bgPrimary.trim() === '') {
            console.warn('⚠️ External CSS not loaded - using inline fallback');
            // The inline CSS will handle it
        } else {
            console.log('✅ Dark theme CSS loaded successfully');
        }
        
        document.body.removeChild(testElement);
        
        // Force dark theme class on body
        document.body.classList.add('dark-theme');
        
        // Apply additional dark theme enforcement
        document.body.style.background = 'linear-gradient(135deg, #0F0F23 0%, #1A1A2E 100%)';
        document.body.style.color = '#FFFFFF';
    });
    </script>
</head>
<body>
    <!-- Header -->
    <header class="admin-header">
        <div class="header-content">
            <div class="header-left">
                <h1 class="header-title">
                    <span class="header-icon">⚡</span>
                    Claim Connectors Admin
                </h1>
                <div class="header-greeting">
                    Good <span id="time-greeting">morning</span>, <span id="admin-name">Admin</span> 
                    <span class="ai-badge">⚡ Powered by Angel Dust OS</span>
                </div>
            </div>
            <div class="header-right">
                <div class="header-date" id="current-date"></div>
                <button class="btn btn-success btn-sm" onclick="openAddAgentModal()">
                    👤 Add Agent
                </button>
                <button class="btn btn-info btn-sm" onclick="openAddPublisherModal()">
                    🏢 Add Publisher
                </button>
                <button class="btn btn-secondary btn-sm" id="refresh-all">🔄 Refresh</button>
                <button class="btn btn-warning btn-sm" onclick="handleLogout()">
                    🚪 Logout
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="admin-main">
        <!-- Quick Stats Grid -->
        <div class="quick-stats-grid">
            <div class="stat-card leads">
                <div class="stat-icon">📋</div>
                <div class="stat-content">
                    <div class="stat-value" id="total-leads">0</div>
                    <div class="stat-label">Total Leads</div>
                    <div class="stat-change positive" id="leads-change">+12% this week</div>
                    <div class="stat-sparkline" id="leads-sparkline"></div>
                </div>
                <div class="stat-expand" onclick="expandChart('leads')">📊</div>
            </div>
            
            <div class="stat-card agents">
                <div class="stat-icon">👥</div>
                <div class="stat-content">
                    <div class="stat-value" id="active-agents">0</div>
                    <div class="stat-label">Active Agents</div>
                    <div class="stat-change positive" id="agents-change">3 online now</div>
                    <div class="stat-visual">
                        <div class="agent-performance-mini" id="agent-performance-mini"></div>
                    </div>
                </div>
                <div class="stat-expand" onclick="expandChart('agents')">📊</div>
            </div>
            
            <div class="stat-card conversion">
                <div class="stat-icon">🎯</div>
                <div class="stat-content">
                    <div class="stat-value" id="conversion-rate">0%</div>
                    <div class="stat-label">Close Rate</div>
                    <div class="stat-change positive" id="conversion-change">+5% improvement</div>
                    <div class="conversion-visual">
                        <div class="progress-ring" id="conversion-ring">
                            <div class="progress-fill" id="conversion-fill"></div>
                        </div>
                    </div>
                </div>
                <div class="stat-expand" onclick="expandChart('conversion')">📊</div>
            </div>
            
            <div class="stat-card revenue">
                <div class="stat-icon">💰</div>
                <div class="stat-content">
                    <div class="stat-value" id="monthly-revenue">$0</div>
                    <div class="stat-label">Monthly Revenue</div>
                    <div class="stat-change positive" id="revenue-change">On track</div>
                    <div class="revenue-forecast-mini" id="revenue-forecast-mini"></div>
                </div>
                <div class="stat-expand" onclick="expandChart('revenue')">📊</div>
            </div>
        </div>

        <!-- Expandable Chart Sections -->
        <div class="chart-modal" id="chart-modal">
            <div class="chart-modal-content">
                <div class="chart-modal-header">
                    <h3 id="chart-modal-title">Detailed Analytics</h3>
                    <button class="chart-modal-close" onclick="closeChartModal()">&times;</button>
                </div>
                <div class="chart-modal-body" id="chart-modal-body">
                    <!-- Dynamic chart content will be injected here -->
                </div>
            </div>
        </div>

        <!-- Enhanced Lead Management Overview -->
        <section class="admin-section">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-icon">📊</span>
                    <h2>Lead Management Overview</h2>
                    <div class="real-time-indicator">
                        <span class="pulse-dot"></span>
                        <span class="real-time-text">Real-time</span>
                    </div>
                </div>
                <div class="section-actions">
                    <button class="btn btn-secondary" onclick="exportLeadData()">📊 Export Data</button>
                    <button class="btn btn-primary" onclick="refreshOverview()">🔄 Refresh</button>
                    <button class="btn btn-info" onclick="expandChart('lead-sources')">📈 Lead Sources</button>
                </div>
            </div>
            
            <div class="overview-grid">
                <div class="overview-card available-leads">
                    <h3>🔍 Available Leads</h3>
                    <div class="overview-metric">
                        <span class="metric-value" id="available-leads-count">0</span>
                        <span class="metric-label">Unclaimed leads</span>
                        <div class="metric-trend" id="available-trend">↗️</div>
                    </div>
                    <div class="overview-details">
                        <div class="detail-item">
                            <span class="detail-label">Hot leads:</span>
                            <span class="detail-value hot-leads" id="hot-leads-count">0</span>
                            <div class="hot-indicator"></div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">This week:</span>
                            <span class="detail-value" id="weekly-leads-count">0</span>
                            <div class="week-progress" id="week-progress"></div>
                        </div>
                    </div>
                    <button class="btn btn-outline" onclick="viewAvailableLeads()">View All</button>
                </div>
                
                <div class="overview-card claimed-leads">
                    <h3>🎯 Claimed Leads</h3>
                    <div class="overview-metric">
                        <span class="metric-value" id="claimed-leads-count">0</span>
                        <span class="metric-label">Being worked</span>
                        <div class="metric-trend" id="claimed-trend">↗️</div>
                    </div>
                    <div class="overview-details">
                        <div class="detail-item">
                            <span class="detail-label">Today:</span>
                            <span class="detail-value" id="todays-claims-count">0</span>
                            <div class="today-progress" id="today-progress"></div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Avg. response:</span>
                            <span class="detail-value" id="avg-response-time">0 min</span>
                            <div class="response-indicator" id="response-indicator"></div>
                        </div>
                    </div>
                    <button class="btn btn-outline" onclick="viewClaimedLeads()">View All</button>
                </div>
                
                <div class="overview-card agent-performance">
                    <h3>🏆 Agent Performance</h3>
                    <div class="overview-metric">
                        <span class="metric-value" id="top-agent-claims">0</span>
                        <span class="metric-label">Top agent claims</span>
                        <div class="metric-trend" id="performance-trend">↗️</div>
                    </div>
                    <div class="overview-details">
                        <div class="detail-item">
                            <span class="detail-label">Best performer:</span>
                            <span class="detail-value" id="top-agent-name">-</span>
                            <div class="performance-star">⭐</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Team avg:</span>
                            <span class="detail-value" id="team-avg-claims">0</span>
                            <div class="team-performance-bar" id="team-performance-bar"></div>
                        </div>
                    </div>
                    <button class="btn btn-outline" onclick="expandChart('agent-performance')">View Details</button>
                </div>
            </div>
        </section>

        <!-- Predictive Analytics -->
        <section class="admin-section">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-icon">🔮</span>
                    <h2>Predictive Analytics</h2>
                    <span class="ai-badge">Angel Dust OS</span>
                </div>
                <div class="section-actions">
                    <button class="btn btn-secondary" onclick="showAnalyticsDetails()">📈 Full Report</button>
                </div>
            </div>
            
            <div class="analytics-grid">
                <div class="analytics-card revenue-forecast">
                    <h4>💰 Revenue Forecast</h4>
                    <div class="revenue-forecast-container">
                        <div class="forecast-main">
                            <div class="forecast-amount">
                                <span class="forecast-value" id="revenue-forecast">$0</span>
                                <span class="forecast-period">Next 30 Days</span>
                            </div>
                            <div class="forecast-confidence">
                                <div class="confidence-label">Confidence Level</div>
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: 95%"></div>
                                    <span class="confidence-value" id="forecast-confidence">95%</span>
                                </div>
                            </div>
                        </div>
                        <div class="forecast-insights">
                            <div class="insight-item">
                                <span class="insight-icon">📈</span>
                                <span class="insight-text">Trending upward</span>
                            </div>
                            <div class="insight-item">
                                <span class="insight-icon">🎯</span>
                                <span class="insight-text">On target for Q4</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-card lead-quality">
                    <h4>⭐ Lead Quality Analysis</h4>
                    <div class="quality-breakdown">
                        <div class="quality-tier hot">
                            <span class="tier-label">Hot</span>
                            <span class="tier-count" id="hot-tier-count">0</span>
                            <span class="tier-percent" id="hot-tier-percent">0%</span>
                        </div>
                        <div class="quality-tier warm">
                            <span class="tier-label">Warm</span>
                            <span class="tier-count" id="warm-tier-count">0</span>
                            <span class="tier-percent" id="warm-tier-percent">0%</span>
                        </div>
                        <div class="quality-tier cold">
                            <span class="tier-label">Cold</span>
                            <span class="tier-count" id="cold-tier-count">0</span>
                            <span class="tier-percent" id="cold-tier-percent">0%</span>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-card performance-insights">
                    <h4>🚀 Performance Insights</h4>
                    <div class="insights-list" id="performance-insights-list">
                        <div class="insight-item">
                            <span class="insight-icon">📊</span>
                            <span class="insight-text">Analyzing performance patterns...</span>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-card trend-analysis">
                    <h4>📈 Trend Analysis</h4>
                    <div class="trend-items" id="trend-analysis-list">
                        <div class="trend-item">
                            <span class="trend-label">Lead Volume:</span>
                            <span class="trend-indicator up">↗️ +15%</span>
                        </div>
                        <div class="trend-item">
                            <span class="trend-label">Response Time:</span>
                            <span class="trend-indicator down">↘️ -8 min</span>
                        </div>
                        <div class="trend-item">
                            <span class="trend-label">Conversion:</span>
                            <span class="trend-indicator up">↗️ +3%</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Recent Activity & Lead Assignment -->
        <div class="admin-grid">
            <section class="admin-section recent-activity">
                <div class="section-header">
                    <div class="section-title">
                        <span class="section-icon">📝</span>
                        <h2>Recent Activity</h2>
                    </div>
                </div>
                
                <div class="activity-feed" id="activity-feed">
                    <div class="activity-item" onclick="expandActivity(this)">
                        <div class="activity-icon">🎯</div>
                        <div class="activity-content">
                            <div class="activity-text">Lead claimed by Sarah</div>
                            <div class="activity-time">2 min ago</div>
                        </div>
                        <div class="activity-expand">+</div>
                        <div class="activity-details">
                            <p>Sarah Johnson successfully claimed lead John Smith (Auto accident case). Lead has been moved to active pipeline for follow-up and qualification.</p>
                        </div>
                    </div>
                    
                    <div class="activity-item" onclick="expandActivity(this)">
                        <div class="activity-icon">📞</div>
                        <div class="activity-content">
                            <div class="activity-text">Contact completed</div>
                            <div class="activity-time">15 min ago</div>
                        </div>
                        <div class="activity-expand">+</div>
                        <div class="activity-details">
                            <p>Mike Davis completed initial contact with Emma Wilson. Medical evaluation scheduled for next week. Case shows strong potential for settlement.</p>
                        </div>
                    </div>
                    
                    <div class="activity-item" onclick="expandActivity(this)">
                        <div class="activity-icon">✅</div>
                        <div class="activity-content">
                            <div class="activity-text">Case qualified</div>
                            <div class="activity-time">1 hour ago</div>
                        </div>
                        <div class="activity-expand">+</div>
                        <div class="activity-details">
                            <p>Robert Brown case has been qualified and approved for representation. All documentation received and case moved to active litigation status.</p>
                        </div>
                    </div>

                    <div class="activity-item" onclick="expandActivity(this)">
                        <div class="activity-icon">📊</div>
                        <div class="activity-content">
                            <div class="activity-text">Target achieved</div>
                            <div class="activity-time">2 hours ago</div>
                        </div>
                        <div class="activity-expand">+</div>
                        <div class="activity-details">
                            <p>Daily revenue target of $125,000 has been reached ahead of schedule. Team performance excellent with 89% conversion rate today.</p>
                        </div>
                    </div>
                </div>
            </section>
            
            <section class="admin-section lead-management">
                <div class="section-header">
                    <div class="section-title">
                        <span class="section-icon">⚙️</span>
                        <h2>Lead Management</h2>
                    </div>
                </div>
                
                <div class="management-actions">
                    <button class="action-btn" onclick="reassignLead()">
                        <span class="btn-icon">🔄</span>
                        <span class="btn-text">Reassign Lead</span>
                    </button>
                    
                    <button class="action-btn" onclick="bulkActions()">
                        <span class="btn-icon">📦</span>
                        <span class="btn-text">Bulk Actions</span>
                    </button>
                    
                    <button class="action-btn" onclick="leadImport()">
                        <span class="btn-icon">📥</span>
                        <span class="btn-text">Import Leads</span>
                    </button>
                    
                    <button class="action-btn" onclick="agentDashboard()">
                        <span class="btn-icon">👤</span>
                        <span class="btn-text">Agent View</span>
                    </button>
                </div>
                
                <div class="quick-filters">
                    <h4>Quick Filters</h4>
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all">All Leads</button>
                        <button class="filter-btn" data-filter="unclaimed">Unclaimed</button>
                        <button class="filter-btn" data-filter="hot">Hot Leads</button>
                        <button class="filter-btn" data-filter="overdue">Overdue</button>
                    </div>
                </div>
            </section>
        </div>

        <!-- AI Insights Summary -->
        <section class="admin-section ai-summary">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-icon">🤖</span>
                    <h2>AI Intelligence Summary</h2>
                    <span class="ai-badge">Real-time</span>
                </div>
            </div>
            
            <div class="ai-insights-grid">
                <div class="ai-insight-card">
                    <div class="insight-header">
                        <span class="insight-type">🎯 Lead Optimization</span>
                        <span class="insight-score">87%</span>
                    </div>
                    <p class="insight-text" id="lead-optimization-insight">
                        Your team is performing well. Focus on referral leads for highest conversion.
                    </p>
                </div>
                
                <div class="ai-insight-card">
                    <div class="insight-header">
                        <span class="insight-type">📊 Performance Coaching</span>
                        <span class="insight-score">92%</span>
                    </div>
                    <p class="insight-text" id="performance-coaching-insight">
                        Agent response times improved 15%. Consider bonus incentives.
                    </p>
                </div>
                
                <div class="ai-insight-card">
                    <div class="insight-header">
                        <span class="insight-type">🔮 Market Prediction</span>
                        <span class="insight-score">78%</span>
                    </div>
                    <p class="insight-text" id="market-prediction-insight">
                        Expect 20% more leads next week. Prepare additional capacity.
                    </p>
                </div>
            </div>
        </section>
    </main>

    <!-- Floating Action Button -->
    <div class="fab-container">
        <button class="fab" id="mainFab">
            <span class="fab-icon">⚡</span>
        </button>
        <div class="fab-menu" id="fabMenu">
            <button class="fab-action" onclick="agentDashboard()">
                <span>👤</span> Agent View
            </button>
            <button class="fab-action" onclick="expandChart('lead-sources')">
                <span>📈</span> Lead Sources
            </button>
        </div>
    </div>

    <!-- Add Agent Modal -->
    <div class="modal-overlay" id="add-agent-modal">
        <div class="modal glass-modal">
            <div class="modal-header">
                <h3 class="modal-title">Add New Agent</h3>
                <button class="modal-close" onclick="closeModal('add-agent-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="new-agent-email" placeholder="agent@example.com" class="form-input">
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="new-agent-role" class="form-input">
                        <option value="agent">Agent - Manage leads</option>
                        <option value="viewer">Viewer - View only</option>
                        <option value="admin">Admin - Full access</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('add-agent-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="handleSendAgentInvite()">Send Invite</button>
            </div>
        </div>
    </div>

    <!-- Add Publisher Modal -->
    <div class="modal-overlay" id="add-publisher-modal">
        <div class="modal glass-modal">
            <div class="modal-header">
                <h3 class="modal-title">Add New Publisher</h3>
                <button class="modal-close" onclick="closeModal('add-publisher-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Publisher Name</label>
                    <input type="text" id="new-publisher-name" placeholder="Publisher Name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>Contact Email</label>
                    <input type="email" id="new-publisher-email" placeholder="contact@publisher.com" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>Vendor Code</label>
                    <input type="text" id="new-publisher-code" placeholder="AUTO-GENERATED" class="form-input" readonly style="background: var(--bg-accent); color: var(--text-muted);">
                </div>
                <div class="form-group">
                    <label>API Key</label>
                    <input type="text" id="new-publisher-api-key" placeholder="AUTO-GENERATED" class="form-input" readonly style="background: var(--bg-accent); color: var(--text-muted);">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="new-publisher-status" class="form-input">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('add-publisher-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="handleCreatePublisher()">Create Publisher</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- External scripts removed - all functionality now inline -->
    <!-- <script src="js/smart-lead-router.js"></script> -->
    <!-- <script src="js/predictive-analytics.js"></script> -->
    <!-- <script src="js/api-service.js"></script> -->
    <!-- <script src="admin.js"></script> -->
    
    <!-- Enhanced Admin JavaScript with AI Integration -->
    <script>
    let aiAssignmentCounter = 0;
    let aiModeEnabled = true;
    
    // GLOBAL HELPER FUNCTIONS - Available immediately
    function generateVendorCode() {
        const prefix = 'PUB';
        const timestamp = Date.now().toString().slice(-6);
        const random = Math.random().toString(36).substr(2, 4).toUpperCase();
        return `${prefix}${timestamp}${random}`;
    }
    
    function generateAPIKey() {
        return 'api_' + Math.random().toString(36).substr(2, 32);
    }

    function addActivityFeedItem(message, type = 'info') {
        const feed = document.getElementById('activity-feed');
        if (!feed) return; // Safety check
        
        const activity = document.createElement('div');
        activity.className = 'activity-item';
        activity.innerHTML = `
            <div class="activity-icon ${type}">
                ${type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️'}
            </div>
            <div class="activity-content">
                <div class="activity-message">${message}</div>
                <div class="activity-time">${new Date().toLocaleTimeString()}</div>
            </div>
        `;
        
        feed.insertBefore(activity, feed.firstChild);
        
        // Keep only last 20 items
        const items = feed.querySelectorAll('.activity-item');
        if (items.length > 20) {
            items[items.length - 1].remove();
        }
    }

    // MODAL CONTROL FUNCTIONS - Globally accessible
    function openAddAgentModal() {
        console.log('👤 Opening Add Agent modal...');
        const modal = document.getElementById('add-agent-modal');
        if (modal) {
            // Clear previous data
            const emailInput = document.getElementById('new-agent-email');
            const roleInput = document.getElementById('new-agent-role');
            
            if (emailInput) emailInput.value = '';
            if (roleInput) roleInput.value = 'agent';
            
            modal.classList.add('active');
            addActivityFeedItem('👤 Add Agent dialog opened', 'info');
        } else {
            console.error('❌ Add Agent modal not found');
        }
    }

    function openAddPublisherModal() {
        console.log('🏢 Opening Add Publisher modal...');
        const modal = document.getElementById('add-publisher-modal');
        if (modal) {
            // Clear and generate new data
            const nameInput = document.getElementById('new-publisher-name');
            const emailInput = document.getElementById('new-publisher-email');
            const codeInput = document.getElementById('new-publisher-code');
            const keyInput = document.getElementById('new-publisher-api-key');
            const statusInput = document.getElementById('new-publisher-status');
            
            if (nameInput) nameInput.value = '';
            if (emailInput) emailInput.value = '';
            if (codeInput) codeInput.value = generateVendorCode();
            if (keyInput) keyInput.value = generateAPIKey();
            if (statusInput) statusInput.value = 'active';
            
            modal.classList.add('active');
            addActivityFeedItem('🏢 Add Publisher dialog opened', 'info');
        } else {
            console.error('❌ Add Publisher modal not found');
        }
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('active');
        }
    }

    function handleSendAgentInvite() {
        const email = document.getElementById('new-agent-email').value;
        const role = document.getElementById('new-agent-role').value;
        
        if (!email) {
            alert('Please enter an email address');
            return;
        }
        
        console.log('📧 Sending agent invite:', { email, role });
        
        // Here you would call your API to create the agent
        addActivityFeedItem(`📧 Agent invite sent to ${email}`, 'success');
        closeModal('add-agent-modal');
    }

    function handleCreatePublisher() {
        const name = document.getElementById('new-publisher-name').value;
        const email = document.getElementById('new-publisher-email').value;
        const vendorCode = document.getElementById('new-publisher-code').value;
        const apiKey = document.getElementById('new-publisher-api-key').value;
        const status = document.getElementById('new-publisher-status').value;
        
        if (!name || !email) {
            alert('Please fill in all required fields');
            return;
        }
        
        console.log('🏢 Creating publisher:', { name, email, vendorCode, apiKey, status });
        
        // Generate and download posting instructions and API documentation
        generatePublisherPackage(name, email, vendorCode, apiKey);
        
        // Also generate and download PDF instructions
        downloadPublisherInstructionsAsPdf(name, email, vendorCode, apiKey);
        
        // Here you would call your API to create the publisher
        addActivityFeedItem(`🏢 Publisher "${name}" created successfully`, 'success');
        addActivityFeedItem(`📄 Publisher package downloaded for ${name}`, 'info');
        addActivityFeedItem(`📄 PDF instructions downloaded for ${name}`, 'info');
        closeModal('add-publisher-modal');
    }

    function handleLogout() {
        // Confirm logout action
        if (confirm('Are you sure you want to logout?')) {
            console.log('🚪 Logging out admin user...');
            
            // Clear authentication data
            localStorage.clear();
            sessionStorage.clear();
            
            // Clear any cookies related to authentication
            document.cookie.split(";").forEach(function(c) { 
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
            });
            
            // Show logout message
            addActivityFeedItem('🚪 Admin logged out successfully', 'info');
            
            // Redirect to login page after a short delay
            setTimeout(() => {
                // Try multiple possible login/home pages
                const possiblePages = ['login.html', 'index.html', '/', '../index.html'];
                let redirected = false;
                
                // Try to redirect to the most likely login page
                for (const page of possiblePages) {
                    try {
                        window.location.href = page;
                        redirected = true;
                        break;
                    } catch (error) {
                        console.log(`Could not redirect to ${page}:`, error);
                    }
                }
                
                // Fallback: just reload the current page (which should redirect to login if auth is required)
                if (!redirected) {
                    window.location.reload();
                }
            }, 1000);
        }
    }

    function generatePublisherPackage(publisherName, email, vendorCode, apiKey) {
        // Generate comprehensive posting instructions and API documentation
        const publisherPackage = generatePublisherDocumentation(publisherName, email, vendorCode, apiKey);
        
        // Create downloadable ZIP file with all documentation
        if (typeof JSZip !== 'undefined') {
            const zip = new JSZip();
            
            // Add posting instructions
            zip.file("posting-instructions.html", publisherPackage.instructions);
            zip.file("api-documentation.md", publisherPackage.apiDocs);
            zip.file("integration-guide.txt", publisherPackage.integrationGuide);
            zip.file("sample-code.js", publisherPackage.sampleCode);
            zip.file("publisher-credentials.txt", publisherPackage.credentials);
            
            // Generate and download the ZIP file
            zip.generateAsync({type:"blob"}).then(function(content) {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = `${publisherName.replace(/\s+/g, '-')}-publisher-package.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                console.log('✅ Publisher package downloaded successfully');
            }).catch(function(error) {
                console.error('❌ Error generating ZIP file:', error);
                // Fallback: just log the publisher info
                alert('Publisher created successfully! Package generation had an issue, but publisher is saved.');
            });
        } else {
            console.warn('JSZip not available, skipping package download');
            alert('Publisher created successfully! (Package download requires JSZip)');
        }
    }

    function generatePublisherDocumentation(publisherName, email, vendorCode, apiKey) {
        const baseUrl = window.APP_CONFIG?.apiEndpoint || 'https://9qtb4my1ij.execute-api.us-east-1.amazonaws.com/prod';
        
        const instructions = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claim Connectors - Publisher Integration Guide</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6; }
        .header { background: linear-gradient(135deg, #3B82F6, #8B5CF6); color: white; padding: 30px; border-radius: 10px; text-align: center; margin-bottom: 30px; }
        .section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3B82F6; }
        .code { background: #1e1e1e; color: #f8f8f2; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; overflow-x: auto; }
        .warning { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #3B82F6; color: white; }
    </style>
</head>
<body>
    <div class="header">
        <h1>🚀 Claim Connectors Publisher Integration</h1>
        <p>Welcome ${publisherName}! Your complete integration package</p>
    </div>

    <div class="section">
        <h2>📋 Your Publisher Credentials</h2>
        <table>
            <tr><th>Field</th><th>Value</th></tr>
            <tr><td>Publisher Name</td><td>${publisherName}</td></tr>
            <tr><td>Contact Email</td><td>${email}</td></tr>
            <tr><td>Vendor Code</td><td><strong>${vendorCode}</strong></td></tr>
            <tr><td>API Key</td><td><strong>${apiKey}</strong></td></tr>
            <tr><td>API Endpoint</td><td>${baseUrl}</td></tr>
        </table>
        <div class="warning">
            <strong>⚠️ Important:</strong> Keep your API key secure and never share it publicly.
        </div>
    </div>

    <div class="section">
        <h2>🔗 Lead Posting Instructions</h2>
        <p>To send leads to Claim Connectors, POST to our lead submission endpoint:</p>
        
        <h3>Endpoint:</h3>
        <div class="code">POST ${baseUrl}/leads</div>
        
        <h3>Headers Required:</h3>
        <div class="code">
Content-Type: application/json
X-API-Key: ${apiKey}
X-Vendor-Code: ${vendorCode}
        </div>
        
        <h3>Lead Data Format:</h3>
        <div class="code">
{
  "first_name": "John",
  "last_name": "Smith", 
  "email": "john.smith@email.com",
  "phone_home": "(555) 123-4567",
  "state": "CA",
  "incident_type": "auto_accident",
  "vendor_code": "${vendorCode}"
}
        </div>
    </div>

    <div class="success">
        <h3>✅ Integration Complete!</h3>
        <p>Once implemented, leads will flow directly into our system.</p>
    </div>
</body>
</html>`;

        const apiDocs = `# Claim Connectors API Documentation

## Publisher: ${publisherName}
## Generated: ${new Date().toISOString()}

### Authentication
- **API Key:** ${apiKey}
- **Vendor Code:** ${vendorCode}

### Endpoints

#### Submit Lead
POST ${baseUrl}/leads
Content-Type: application/json
X-API-Key: ${apiKey}
X-Vendor-Code: ${vendorCode}

### Field Validation Rules
- **email**: Must be valid email format
- **phone_home**: US phone number format
- **state**: Must be valid US state code

### Rate Limits
- Maximum 100 requests per minute
- Maximum 10,000 leads per day

### Error Codes
- 400: Bad Request (validation error)
- 401: Unauthorized (invalid API key)
- 429: Rate limit exceeded
- 500: Internal server error`;

        const sampleCode = `// Claim Connectors Lead Submission - JavaScript Example
// Publisher: ${publisherName}

const CLAIM_CONNECTORS_CONFIG = {
    apiEndpoint: '${baseUrl}',
    apiKey: '${apiKey}',
    vendorCode: '${vendorCode}'
};

async function submitLead(leadData) {
    try {
        const response = await fetch(\`\${CLAIM_CONNECTORS_CONFIG.apiEndpoint}/leads\`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-API-Key': CLAIM_CONNECTORS_CONFIG.apiKey,
                'X-Vendor-Code': CLAIM_CONNECTORS_CONFIG.vendorCode
            },
            body: JSON.stringify({
                ...leadData,
                vendor_code: CLAIM_CONNECTORS_CONFIG.vendorCode,
                source: '${publisherName}'
            })
        });

        const result = await response.json();
        
        if (response.ok) {
            console.log('Lead submitted successfully:', result);
            return { success: true, data: result };
        } else {
            console.error('Lead submission failed:', result);
            return { success: false, error: result };
        }
    } catch (error) {
        console.error('Network error:', error);
        return { success: false, error: error.message };
    }
}`;

        const credentials = `CLAIM CONNECTORS PUBLISHER CREDENTIALS
=====================================

Publisher Name: ${publisherName}
Contact Email: ${email}
Vendor Code: ${vendorCode}
API Key: ${apiKey}
API Endpoint: ${baseUrl}

IMPORTANT SECURITY NOTES:
- Never share your API key publicly
- Use HTTPS for all API requests  
- Store credentials securely

Support Contact:
Email: publishers@claimconnectors.com
Phone: (555) CLAIM-01`;

        return {
            instructions,
            apiDocs,
            integrationGuide: "Complete integration guide and API documentation provided",
            sampleCode,
            credentials
        };
    }

    // Download publisher instructions as PDF
    function downloadPublisherInstructionsAsPdf(publisherName, email, vendorCode, apiKey) {
        const { jsPDF } = window.jspdf;
        const baseUrl = window.APP_CONFIG?.apiEndpoint || 'https://9qtb4my1ij.execute-api.us-east-1.amazonaws.com/prod';
        
        try {
            // Create a new PDF document
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            // Add header
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('Claim Connectors - API Integration', 20, 25);
            
            doc.setFontSize(16);
            doc.text(`Publisher: ${publisherName}`, 20, 35);
            
            // Add publisher credentials section
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Publisher Credentials', 20, 50);
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Publisher Name: ${publisherName}`, 25, 60);
            doc.text(`Contact Email: ${email}`, 25, 67);
            doc.text(`Vendor Code: ${vendorCode}`, 25, 74);
            doc.text(`API Key: ${apiKey}`, 25, 81);
            doc.text(`API Endpoint: ${baseUrl}`, 25, 88);
            
            // Add warning box
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text('⚠️ IMPORTANT: Keep your API key secure and never share it publicly.', 25, 98);
            
            // Add API instructions section
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Lead Submission Instructions', 20, 115);
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('To send leads to Claim Connectors, POST to our lead submission endpoint:', 25, 125);
            
            // Endpoint
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Endpoint:', 25, 135);
            doc.setFont(undefined, 'normal');
            doc.text(`POST ${baseUrl}/leads`, 25, 142);
            
            // Headers
            doc.setFont(undefined, 'bold');
            doc.text('Required Headers:', 25, 152);
            doc.setFont(undefined, 'normal');
            doc.text('Content-Type: application/json', 25, 159);
            doc.text(`X-API-Key: ${apiKey}`, 25, 166);
            doc.text(`X-Vendor-Code: ${vendorCode}`, 25, 173);
            
            // Sample payload
            doc.setFont(undefined, 'bold');
            doc.text('Sample Lead Data:', 25, 183);
            
            doc.setFont('courier', 'normal');
            doc.setFontSize(8);
            const samplePayload = [
                '{',
                '  "first_name": "John",',
                '  "last_name": "Smith",',
                '  "email": "john.smith@email.com",',
                '  "phone_home": "(555) 123-4567",',
                '  "state": "CA",',
                '  "incident_type": "auto_accident",',
                `  "vendor_code": "${vendorCode}"`,
                '}'
            ];
            
            let yPos = 190;
            samplePayload.forEach(line => {
                doc.text(line, 25, yPos);
                yPos += 5;
            });
            
            // Add response format
            doc.setFont(undefined, 'bold');
            doc.setFontSize(10);
            doc.text('Success Response Format:', 25, yPos + 10);
            
            doc.setFont('courier', 'normal');
            doc.setFontSize(8);
            yPos += 17;
            const responseFormat = [
                '{',
                '  "status": "success",',
                '  "lead_id": "uuid-string",',
                '  "message": "Lead received"',
                '}'
            ];
            
            responseFormat.forEach(line => {
                doc.text(line, 25, yPos);
                yPos += 5;
            });
            
            // Add support information
            doc.setFont(undefined, 'bold');
            doc.setFontSize(10);
            doc.text('Support Contact:', 25, yPos + 15);
            doc.setFont(undefined, 'normal');
            doc.text('Email: publishers@claimconnectors.com', 25, yPos + 22);
            doc.text('Phone: (555) CLAIM-01', 25, yPos + 29);
            
            // Add footer
            doc.setFontSize(8);
            doc.setTextColor(128, 128, 128);
            doc.text(`Generated on: ${new Date().toLocaleString()}`, 20, 280);
            doc.text('Claim Connectors - Lead Management System', 20, 285);
            
            // Generate the PDF filename
            const filename = `${publisherName.replace(/[^a-zA-Z0-9]/g, '_')}_API_Instructions.pdf`;
            
            // Save the PDF
            doc.save(filename);
            
            console.log('✅ Publisher PDF instructions downloaded successfully');
            
        } catch (err) {
            console.error('Failed to generate PDF: ', err);
            alert('Failed to generate PDF. Please try again.');
        }
    }

    // Expose functions to global scope immediately
    window.generateVendorCode = generateVendorCode;
    window.generateAPIKey = generateAPIKey;
    window.openAddAgentModal = openAddAgentModal;
    window.openAddPublisherModal = openAddPublisherModal;
    window.closeModal = closeModal;
    window.handleSendAgentInvite = handleSendAgentInvite;
    window.handleCreatePublisher = handleCreatePublisher;
    window.addActivityFeedItem = addActivityFeedItem;
    window.handleLogout = handleLogout;
    window.generatePublisherPackage = generatePublisherPackage;
    window.generatePublisherDocumentation = generatePublisherDocumentation;
    window.downloadPublisherInstructionsAsPdf = downloadPublisherInstructionsAsPdf;

    console.log('✅ All modal functions are now globally accessible');
    
    document.addEventListener('DOMContentLoaded', function() {
        // Handle modal close buttons
        document.querySelectorAll('.modal-close').forEach(closeBtn => {
            closeBtn.addEventListener('click', function() {
                const modal = this.closest('.modal-overlay');
                if (modal) {
                    modal.classList.remove('active');
                }
            });
        });
        
        // Handle FAB menu (simplified)
        const mainFab = document.getElementById('mainFab');
        if (mainFab) {
            mainFab.addEventListener('click', function() {
                document.querySelector('.fab-container').classList.toggle('active');
            });
        }
        
        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.classList.remove('active');
            }
        });
        
        // Update date and time
        function updateDateTime() {
            const now = new Date();
            const hour = now.getHours();
            let greeting = 'morning';
            
            if (hour >= 12 && hour < 17) greeting = 'afternoon';
            else if (hour >= 17) greeting = 'evening';
            
            const greetingEl = document.getElementById('time-greeting');
            const dateEl = document.getElementById('current-date');
            
            if (greetingEl) greetingEl.textContent = greeting;
            if (dateEl) {
                dateEl.textContent = now.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
        }
        
        updateDateTime();
        setInterval(updateDateTime, 60000); // Update every minute
        
        // Initialize with some mock data
        setTimeout(() => {
            addActivityFeedItem('System ready', 'success');
        }, 2000);
        
        console.log('🎯 Enhanced admin dashboard initialized');
    });

    // EXPANDABLE ACTIVITY FUNCTIONALITY
    function expandActivity(activityElement) {
        // Close all other expanded items
        document.querySelectorAll('.activity-item.expanded').forEach(item => {
            if (item !== activityElement) {
                item.classList.remove('expanded');
            }
        });
        
        // Toggle current item
        activityElement.classList.toggle('expanded');
    }

    // Expose expandActivity globally
    window.expandActivity = expandActivity;

    // Navigation functions for admin dashboard
    function exportLeadData() {
        console.log('📊 Exporting lead data...');
        addActivityFeedItem('📊 Lead export started', 'info');
    }

    function refreshOverview() {
        console.log('🔄 Refreshing overview...');
        addActivityFeedItem('🔄 Overview data refreshed', 'success');
    }

    function viewAvailableLeads() {
        console.log('🔍 Viewing available leads...');
        addActivityFeedItem('👁️ Viewing available leads', 'info');
    }

    function viewClaimedLeads() {
        console.log('🎯 Viewing claimed leads...');
        addActivityFeedItem('👁️ Viewing claimed leads', 'info');
    }

    function showAnalyticsDetails() {
        console.log('📈 Opening analytics details...');
        addActivityFeedItem('📈 Analytics feature temporarily disabled', 'info');
    }

    function reassignLead() {
        console.log('🔄 Reassigning lead...');
        addActivityFeedItem('🔄 Lead reassignment initiated', 'info');
    }

    function bulkActions() {
        console.log('📦 Bulk actions...');
        addActivityFeedItem('📦 Bulk actions opened', 'info');
    }

    function leadImport() {
        console.log('📥 Lead import...');
        addActivityFeedItem('📥 Lead import started', 'info');
    }

    function agentDashboard() {
        console.log('👤 Opening agent dashboard...');
        addActivityFeedItem('👤 Agent dashboard opened', 'info');
    }

    // CHART MODAL FUNCTIONALITY
    function expandChart(type) {
        console.log(`📊 Expanding chart: ${type}`);
        addActivityFeedItem(`📊 Opened ${type} chart`, 'info');
        
        // For now, just show a simple message
        // In the future, this could open actual chart modals
        alert(`Chart view for "${type}" - Feature coming soon!`);
    }

    function closeChartModal() {
        console.log('❌ Closing chart modal');
        const modal = document.getElementById('chart-modal');
        if (modal) {
            modal.classList.remove('active');
        }
    }

    // Expose all functions globally
    window.expandChart = expandChart;
    window.closeChartModal = closeChartModal;
    </script>
</body>
</html>
