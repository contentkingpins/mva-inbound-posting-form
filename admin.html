<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - MVA CRM</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    
    <!-- Preconnect to CDNs -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://unpkg.com/lucide@latest/dist/lucide.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <!-- CountUp.js for number animations -->
    <script src="https://unpkg.com/countup.js@2.8.0/dist/countUp.umd.js"></script>
    
    <!-- MASTER DARK THEME - Single source of truth -->
    <link rel="stylesheet" href="css/master-dark-theme.css">
    
    <!-- FALLBACK: Inline critical dark theme styles for instant loading -->
    <style>
    /* Critical dark theme styles - loads immediately */
    :root {
        --bg-primary: #0F0F23;
        --bg-secondary: #1A1A2E;
        --bg-accent: #16213E;
        --bg-glass: rgba(26, 26, 46, 0.95);
        --text-primary: #FFFFFF;
        --text-secondary: #CBD5E1;
        --text-muted: #9CA3AF;
        --accent-blue: #3B82F6;
        --accent-purple: #8B5CF6;
        --success: #10B981;
        --warning: #F59E0B;
        --error: #EF4444;
        --border-subtle: rgba(139, 92, 246, 0.2);
        --border-accent: rgba(59, 130, 246, 0.3);
        --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        --space-4: 1rem;
        --space-6: 1.5rem;
        --radius-lg: 0.75rem;
        --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5);
        --transition-base: 0.3s ease;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
        font-family: var(--font-family);
        background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
        color: var(--text-primary);
        min-height: 100vh;
        line-height: 1.6;
    }
    
    .admin-header {
        background: var(--bg-glass);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--border-subtle);
        padding: var(--space-4) var(--space-6);
        position: sticky;
        top: 0;
        z-index: 100;
    }
    
    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .header-title {
        color: var(--accent-purple);
        font-size: 1.5rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .admin-main {
        max-width: 1400px;
        margin: 0 auto;
        padding: var(--space-6);
        min-height: calc(100vh - 80px);
    }
    
    .quick-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.25rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: var(--bg-glass);
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        padding: 1.25rem;
        transition: all var(--transition-base);
    }
    
    .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        border: none;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all var(--transition-base);
        text-decoration: none;
    }
    
    .btn-primary {
        background: var(--accent-blue);
        color: white;
    }
    
    .btn-secondary {
        background: var(--bg-accent);
        color: var(--text-primary);
        border: 1px solid var(--border-subtle);
    }

    /* GLOBAL HELPER FUNCTIONS & FIXES */
    .btn-info {
        background: #3B82F6 !important;
        color: white;
        border: none;
    }

    .btn-info:hover {
        background: #2563EB !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    /* ENSURE MODALS WORK PROPERLY */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        z-index: 10000;
        align-items: center;
        justify-content: center;
    }

    .modal-overlay.active {
        display: flex !important;
    }

    .glass-modal {
        background: var(--bg-glass);
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        padding: 2rem 2rem 1rem;
        border-bottom: 1px solid var(--border-subtle);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        color: var(--text-primary);
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        color: var(--text-muted);
        font-size: 2rem;
        cursor: pointer;
        padding: 0;
        line-height: 1;
        transition: color var(--transition-base);
    }

    .modal-close:hover {
        color: var(--text-primary);
    }

    .modal-body {
        padding: 2rem;
    }

    .modal-footer {
        padding: 1rem 2rem 2rem;
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    /* RESPONSIVE MODAL */
    @media (max-width: 768px) {
        .glass-modal {
            width: 95%;
            margin: 1rem;
        }
        
        .modal-header,
        .modal-body,
        .modal-footer {
            padding: 1.5rem;
        }
        
        .modal-footer {
            flex-direction: column;
        }
        
        .modal-footer .btn {
            width: 100%;
        }
    }
    </style>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Build-Time Injected Configuration -->
    <script>
    window.APP_CONFIG = {
        "userPoolId": "us-east-1_lhc964tLD",
        "clientId": "5t6mane4fnvineksoqb4ta0iu1",
        "apiEndpoint": "https://9qtb4my1ij.execute-api.us-east-1.amazonaws.com/prod",
        "apiUrl": "https://9qtb4my1ij.execute-api.us-east-1.amazonaws.com/prod",
        "apiKey": "",
        "buildTime": "2025-05-29T01:13:52.266Z",
        "buildEnv": "production"
    };
    window.preloadedConfig = window.APP_CONFIG;
    console.log('üîß Configuration injected at build time - no external loading needed');
    
    // üé® DARK THEME ENFORCER - Ensures dark theme always loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üé® Dark Theme Enforcer - Checking CSS...');
        
        // Test if external CSS loaded by checking for custom properties
        const testElement = document.createElement('div');
        testElement.style.display = 'none';
        document.body.appendChild(testElement);
        
        const computedStyle = getComputedStyle(testElement);
        const bgPrimary = computedStyle.getPropertyValue('--bg-primary');
        
        if (!bgPrimary || bgPrimary.trim() === '') {
            console.warn('‚ö†Ô∏è External CSS not loaded - using inline fallback');
            // The inline CSS will handle it
        } else {
            console.log('‚úÖ Dark theme CSS loaded successfully');
        }
        
        document.body.removeChild(testElement);
        
        // Force dark theme class on body
        document.body.classList.add('dark-theme');
        
        // Apply additional dark theme enforcement
        document.body.style.background = 'linear-gradient(135deg, #0F0F23 0%, #1A1A2E 100%)';
        document.body.style.color = '#FFFFFF';
    });
    </script>
</head>
<body>
    <!-- Header -->
    <header class="admin-header">
        <div class="header-content">
            <div class="header-left">
                <h1 class="header-title">
                    <span class="header-icon">‚ö°</span>
                    MVA CRM Admin
                </h1>
                <div class="header-greeting">
                    Good <span id="time-greeting">morning</span>, <span id="admin-name">Admin</span> 
                    <span class="ai-badge">‚ö° Powered by Angel Dust OS</span>
                </div>
            </div>
            <div class="header-right">
                <div class="header-date" id="current-date"></div>
                <button class="btn btn-success btn-sm" onclick="openAddAgentModal()">
                    üë§ Add Agent
                </button>
                <button class="btn btn-info btn-sm" onclick="openAddPublisherModal()">
                    üè¢ Add Publisher
                </button>
                <button class="btn btn-secondary btn-sm" onclick="window.open('smart-lead-router-demo.html', '_blank')">
                    ü§ñ AI Demo
                </button>
                <button class="btn btn-secondary btn-sm" id="refresh-all">üîÑ Refresh</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="admin-main">
        <!-- Quick Stats Grid -->
        <div class="quick-stats-grid">
            <div class="stat-card leads">
                <div class="stat-icon">üìã</div>
                <div class="stat-content">
                    <div class="stat-value" id="total-leads">0</div>
                    <div class="stat-label">Total Leads</div>
                    <div class="stat-change positive" id="leads-change">+12% this week</div>
                </div>
            </div>
            
            <div class="stat-card agents">
                <div class="stat-icon">üë•</div>
                <div class="stat-content">
                    <div class="stat-value" id="active-agents">0</div>
                    <div class="stat-label">Active Agents</div>
                    <div class="stat-change positive" id="agents-change">3 online now</div>
                </div>
            </div>
            
            <div class="stat-card conversion">
                <div class="stat-icon">üéØ</div>
                <div class="stat-content">
                    <div class="stat-value" id="conversion-rate">0%</div>
                    <div class="stat-label">Conversion Rate</div>
                    <div class="stat-change positive" id="conversion-change">+5% improvement</div>
                </div>
            </div>
            
            <div class="stat-card revenue">
                <div class="stat-icon">üí∞</div>
                <div class="stat-content">
                    <div class="stat-value" id="monthly-revenue">$0</div>
                    <div class="stat-label">Monthly Revenue</div>
                    <div class="stat-change positive" id="revenue-change">On track</div>
                </div>
            </div>
        </div>

        <!-- Lead Management Overview -->
        <section class="admin-section">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-icon">üìä</span>
                    <h2>Lead Management Overview</h2>
                </div>
                <div class="section-actions">
                    <button class="btn btn-secondary" onclick="exportLeadData()">üìä Export Data</button>
                    <button class="btn btn-primary" onclick="refreshOverview()">üîÑ Refresh</button>
                </div>
            </div>
            
            <div class="overview-grid">
                <div class="overview-card available-leads">
                    <h3>üîç Available Leads</h3>
                    <div class="overview-metric">
                        <span class="metric-value" id="available-leads-count">0</span>
                        <span class="metric-label">Unclaimed leads</span>
                    </div>
                    <div class="overview-details">
                        <div class="detail-item">
                            <span class="detail-label">Hot leads:</span>
                            <span class="detail-value" id="hot-leads-count">0</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">This week:</span>
                            <span class="detail-value" id="weekly-leads-count">0</span>
                        </div>
                    </div>
                    <button class="btn btn-outline" onclick="viewAvailableLeads()">View All</button>
                </div>
                
                <div class="overview-card claimed-leads">
                    <h3>üéØ Claimed Leads</h3>
                    <div class="overview-metric">
                        <span class="metric-value" id="claimed-leads-count">0</span>
                        <span class="metric-label">Being worked</span>
                    </div>
                    <div class="overview-details">
                        <div class="detail-item">
                            <span class="detail-label">Today:</span>
                            <span class="detail-value" id="todays-claims-count">0</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Avg. response:</span>
                            <span class="detail-value" id="avg-response-time">0 min</span>
                        </div>
                    </div>
                    <button class="btn btn-outline" onclick="viewClaimedLeads()">View All</button>
                </div>
                
                <div class="overview-card agent-performance">
                    <h3>üèÜ Agent Performance</h3>
                    <div class="overview-metric">
                        <span class="metric-value" id="top-agent-claims">0</span>
                        <span class="metric-label">Top agent claims</span>
                    </div>
                    <div class="overview-details">
                        <div class="detail-item">
                            <span class="detail-label">Best performer:</span>
                            <span class="detail-value" id="top-agent-name">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Team avg:</span>
                            <span class="detail-value" id="team-avg-claims">0</span>
                        </div>
                    </div>
                    <button class="btn btn-outline" onclick="viewAgentPerformance()">View Details</button>
                </div>
            </div>
        </section>

        <!-- Predictive Analytics -->
        <section class="admin-section">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-icon">üîÆ</span>
                    <h2>Predictive Analytics</h2>
                    <span class="ai-badge">Angel Dust OS</span>
                </div>
                <div class="section-actions">
                    <button class="btn btn-secondary" onclick="showAnalyticsDetails()">üìà Full Report</button>
                </div>
            </div>
            
            <div class="analytics-grid">
                <div class="analytics-card revenue-forecast">
                    <h4>üí∞ Revenue Forecast</h4>
                    <div class="forecast-display">
                        <div class="forecast-main">
                            <span class="forecast-value" id="revenue-forecast">$0</span>
                            <span class="forecast-period">Next 30 days</span>
                        </div>
                        <div class="forecast-confidence">
                            <span class="confidence-label">Confidence:</span>
                            <span class="confidence-value" id="forecast-confidence">0%</span>
                        </div>
                    </div>
                    <div class="mini-chart" id="revenue-mini-chart"></div>
                </div>
                
                <div class="analytics-card lead-quality">
                    <h4>‚≠ê Lead Quality Analysis</h4>
                    <div class="quality-breakdown">
                        <div class="quality-tier hot">
                            <span class="tier-label">Hot</span>
                            <span class="tier-count" id="hot-tier-count">0</span>
                            <span class="tier-percent" id="hot-tier-percent">0%</span>
                        </div>
                        <div class="quality-tier warm">
                            <span class="tier-label">Warm</span>
                            <span class="tier-count" id="warm-tier-count">0</span>
                            <span class="tier-percent" id="warm-tier-percent">0%</span>
                        </div>
                        <div class="quality-tier cold">
                            <span class="tier-label">Cold</span>
                            <span class="tier-count" id="cold-tier-count">0</span>
                            <span class="tier-percent" id="cold-tier-percent">0%</span>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-card performance-insights">
                    <h4>üöÄ Performance Insights</h4>
                    <div class="insights-list" id="performance-insights-list">
                        <div class="insight-item">
                            <span class="insight-icon">üìä</span>
                            <span class="insight-text">Analyzing performance patterns...</span>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-card trend-analysis">
                    <h4>üìà Trend Analysis</h4>
                    <div class="trend-items" id="trend-analysis-list">
                        <div class="trend-item">
                            <span class="trend-label">Lead Volume:</span>
                            <span class="trend-indicator up">‚ÜóÔ∏è +15%</span>
                        </div>
                        <div class="trend-item">
                            <span class="trend-label">Response Time:</span>
                            <span class="trend-indicator down">‚ÜòÔ∏è -8 min</span>
                        </div>
                        <div class="trend-item">
                            <span class="trend-label">Conversion:</span>
                            <span class="trend-indicator up">‚ÜóÔ∏è +3%</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Recent Activity & Lead Assignment -->
        <div class="admin-grid">
            <section class="admin-section recent-activity">
                <div class="section-header">
                    <div class="section-title">
                        <span class="section-icon">üìù</span>
                        <h2>Recent Activity</h2>
                    </div>
                </div>
                
                <div class="activity-feed" id="activity-feed">
                    <div class="activity-item">
                        <div class="activity-icon">üéØ</div>
                        <div class="activity-content">
                            <div class="activity-text">Sarah Johnson claimed lead John Smith</div>
                            <div class="activity-time">2 minutes ago</div>
                        </div>
                    </div>
                    
                    <div class="activity-item">
                        <div class="activity-icon">üìû</div>
                        <div class="activity-content">
                            <div class="activity-text">Mike Davis contacted lead Emma Wilson</div>
                            <div class="activity-time">15 minutes ago</div>
                        </div>
                    </div>
                    
                    <div class="activity-item">
                        <div class="activity-icon">‚úÖ</div>
                        <div class="activity-content">
                            <div class="activity-text">Lead qualified: Robert Brown</div>
                            <div class="activity-time">1 hour ago</div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section class="admin-section lead-management">
                <div class="section-header">
                    <div class="section-title">
                        <span class="section-icon">‚öôÔ∏è</span>
                        <h2>Lead Management</h2>
                    </div>
                </div>
                
                <div class="management-actions">
                    <button class="action-btn" onclick="reassignLead()">
                        <span class="btn-icon">üîÑ</span>
                        <span class="btn-text">Reassign Lead</span>
                    </button>
                    
                    <button class="action-btn" onclick="bulkActions()">
                        <span class="btn-icon">üì¶</span>
                        <span class="btn-text">Bulk Actions</span>
                    </button>
                    
                    <button class="action-btn" onclick="leadImport()">
                        <span class="btn-icon">üì•</span>
                        <span class="btn-text">Import Leads</span>
                    </button>
                    
                    <button class="action-btn" onclick="agentDashboard()">
                        <span class="btn-icon">üë§</span>
                        <span class="btn-text">Agent View</span>
                    </button>
                </div>
                
                <div class="quick-filters">
                    <h4>Quick Filters</h4>
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all">All Leads</button>
                        <button class="filter-btn" data-filter="unclaimed">Unclaimed</button>
                        <button class="filter-btn" data-filter="hot">Hot Leads</button>
                        <button class="filter-btn" data-filter="overdue">Overdue</button>
                    </div>
                </div>
            </section>
        </div>

        <!-- AI Insights Summary -->
        <section class="admin-section ai-summary">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-icon">ü§ñ</span>
                    <h2>AI Intelligence Summary</h2>
                    <span class="ai-badge">Real-time</span>
                </div>
            </div>
            
            <div class="ai-insights-grid">
                <div class="ai-insight-card">
                    <div class="insight-header">
                        <span class="insight-type">üéØ Lead Optimization</span>
                        <span class="insight-score">87%</span>
                    </div>
                    <p class="insight-text" id="lead-optimization-insight">
                        Your team is performing well. Focus on referral leads for highest conversion.
                    </p>
                </div>
                
                <div class="ai-insight-card">
                    <div class="insight-header">
                        <span class="insight-type">üìä Performance Coaching</span>
                        <span class="insight-score">92%</span>
                    </div>
                    <p class="insight-text" id="performance-coaching-insight">
                        Agent response times improved 15%. Consider bonus incentives.
                    </p>
                </div>
                
                <div class="ai-insight-card">
                    <div class="insight-header">
                        <span class="insight-type">üîÆ Market Prediction</span>
                        <span class="insight-score">78%</span>
                    </div>
                    <p class="insight-text" id="market-prediction-insight">
                        Expect 20% more leads next week. Prepare additional capacity.
                    </p>
                </div>
            </div>
        </section>
    </main>

    <!-- Floating Action Button -->
    <div class="fab-container">
        <button class="fab" id="mainFab">
            <span class="fab-icon">‚ö°</span>
        </button>
        <div class="fab-menu" id="fabMenu">
            <button class="fab-action" onclick="exportLeadData()">
                <span>üìä</span> Export Data
            </button>
            <button class="fab-action" onclick="refreshOverview()">
                <span>üîÑ</span> Refresh All
            </button>
            <button class="fab-action" onclick="agentDashboard()">
                <span>üë§</span> Agent View
            </button>
            <button class="fab-action" onclick="viewAnalyticsDetails()">
                <span>üìà</span> Analytics
            </button>
        </div>
    </div>

    <!-- Add Agent Modal -->
    <div class="modal-overlay" id="add-agent-modal">
        <div class="modal glass-modal">
            <div class="modal-header">
                <h3 class="modal-title">Add New Agent</h3>
                <button class="modal-close" onclick="closeModal('add-agent-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="new-agent-email" placeholder="agent@example.com" class="form-input">
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="new-agent-role" class="form-input">
                        <option value="agent">Agent - Manage leads</option>
                        <option value="viewer">Viewer - View only</option>
                        <option value="admin">Admin - Full access</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('add-agent-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="handleSendAgentInvite()">Send Invite</button>
            </div>
        </div>
    </div>

    <!-- Add Publisher Modal -->
    <div class="modal-overlay" id="add-publisher-modal">
        <div class="modal glass-modal">
            <div class="modal-header">
                <h3 class="modal-title">Add New Publisher</h3>
                <button class="modal-close" onclick="closeModal('add-publisher-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Publisher Name</label>
                    <input type="text" id="new-publisher-name" placeholder="Publisher Name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>Contact Email</label>
                    <input type="email" id="new-publisher-email" placeholder="contact@publisher.com" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>Vendor Code</label>
                    <input type="text" id="new-publisher-code" placeholder="AUTO-GENERATED" class="form-input" readonly style="background: var(--bg-accent); color: var(--text-muted);">
                </div>
                <div class="form-group">
                    <label>API Key</label>
                    <input type="text" id="new-publisher-api-key" placeholder="AUTO-GENERATED" class="form-input" readonly style="background: var(--bg-accent); color: var(--text-muted);">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="new-publisher-status" class="form-input">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('add-publisher-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="handleCreatePublisher()">Create Publisher</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/smart-lead-router.js"></script>
    <script src="js/predictive-analytics.js"></script>
    <script src="js/api-service.js"></script>
    <script src="admin.js"></script>
    
    <!-- Enhanced Admin JavaScript with AI Integration -->
    <script>
    let aiAssignmentCounter = 0;
    let aiModeEnabled = true;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-generate vendor codes and API keys
        function generateVendorCode() {
            const prefix = 'PUB';
            const timestamp = Date.now().toString().slice(-6);
            const random = Math.random().toString(36).substr(2, 4).toUpperCase();
            return `${prefix}${timestamp}${random}`;
        }
        
        function generateAPIKey() {
            return 'api_' + Math.random().toString(36).substr(2, 32);
        }
        
        // Handle collapsible sections
        document.querySelectorAll('.section-toggle').forEach(toggle => {
            toggle.addEventListener('click', function() {
                const sectionName = this.dataset.section;
                const content = document.getElementById(sectionName + '-content');
                const icon = this.querySelector('.toggle-icon');
                
                // Toggle active state
                this.classList.toggle('active');
                content.classList.toggle('expanded');
                
                // Rotate icon
                if (this.classList.contains('active')) {
                    icon.textContent = '‚ñ≤';
                } else {
                    icon.textContent = '‚ñº';
                }
                
                // Load predictive analytics when section is opened
                if (sectionName === 'predictive-analytics' && this.classList.contains('active')) {
                    loadPredictiveAnalytics();
                }
            });
        });
        
        // Handle modals
        document.querySelectorAll('[data-modal]').forEach(trigger => {
            trigger.addEventListener('click', function() {
                const modalId = this.dataset.modal;
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.toggle('active');
                }
            });
        });
        
        // Handle modal close buttons
        document.querySelectorAll('.modal-close').forEach(closeBtn => {
            closeBtn.addEventListener('click', function() {
                const modal = this.closest('.modal-overlay');
                if (modal) {
                    modal.classList.remove('active');
                }
            });
        });
        
        // Handle FAB menu (simplified)
        document.getElementById('mainFab').addEventListener('click', function() {
            document.querySelector('.fab-container').classList.toggle('active');
        });
        
        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.classList.remove('active');
            }
        });
        
        // Update date and time
        function updateDateTime() {
            const now = new Date();
            const hour = now.getHours();
            let greeting = 'morning';
            
            if (hour >= 12 && hour < 17) greeting = 'afternoon';
            else if (hour >= 17) greeting = 'evening';
            
            document.getElementById('time-greeting').textContent = greeting;
            document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
        
        updateDateTime();
        setInterval(updateDateTime, 60000); // Update every minute
        
        // Initialize AI features
        initializeAIFeatures();
        
        // Initialize predictive analytics
        initializePredictiveAnalytics();
        
        console.log('üéØ Enhanced admin dashboard initialized with AI features');
    });

    // AI Feature Functions
    function initializeAIFeatures() {
        updateAIMetrics();
        setInterval(updateAIMetrics, 10000); // Update every 10 seconds
        
        // Simulate some AI activity
        setTimeout(() => {
            addAIAssignment({
                leadName: 'Jane Smith',
                agentName: 'Sarah Johnson',
                score: 95,
                time: '2 min ago'
            });
        }, 5000);
    }

    async function updateAIMetrics() {
        try {
            if (window.smartLeadRouter) {
                const queueStatus = await window.smartLeadRouter.getQueueStatus();
                const performanceMetrics = await window.smartLeadRouter.getPerformanceMetrics();
                
                document.getElementById('ai-queue-status').textContent = 
                    queueStatus.size > 0 ? `${queueStatus.size} waiting` : 'All assigned';
                document.getElementById('ai-assignment-time').textContent = 
                    `${performanceMetrics.averageAssignmentTime}s`;
                document.getElementById('ai-assignments').textContent = aiAssignmentCounter;
            }
        } catch (error) {
            console.error('Failed to update AI metrics:', error);
        }
    }

    function testAIAssignment() {
        // Generate a test lead
        const testLead = {
            first_name: 'Test',
            last_name: 'Lead',
            email: 'test@example.com',
            phone_home: '(555) 123-4567',
            state: 'CA',
            zip_code: '90210',
            source: 'website',
            lead_value: 5000,
            notes: 'AI test assignment'
        };

        addActivityFeedItem('ü§ñ Testing AI assignment system...', 'info');

        // Process through AI
        window.smartLeadRouter.assignLeadIntelligently(testLead)
            .then(assignment => {
                addAIAssignment({
                    leadName: `${testLead.first_name} ${testLead.last_name}`,
                    agentName: assignment.agentName || 'Queued',
                    score: assignment.agentScore?.total || 'N/A',
                    time: 'Just now'
                });
                
                aiAssignmentCounter++;
                updateAIMetrics();
                
                addActivityFeedItem(
                    `‚úÖ AI assigned ${testLead.first_name} ${testLead.last_name} to ${assignment.agentName || 'queue'}`,
                    'success'
                );
            })
            .catch(error => {
                addActivityFeedItem('‚ùå AI assignment test failed', 'error');
            });
    }

    function addAIAssignment(assignment) {
        const listContainer = document.getElementById('ai-assignment-list');
        
        // Remove empty message
        const emptyMessage = listContainer.querySelector('.ai-assignment-empty');
        if (emptyMessage) {
            emptyMessage.remove();
        }
        
        const assignmentElement = document.createElement('div');
        assignmentElement.className = 'ai-assignment-item';
        assignmentElement.innerHTML = `
            <div class="ai-assignment-info">
                <div class="ai-assignment-lead">${assignment.leadName}</div>
                <div class="ai-assignment-agent">‚Üí ${assignment.agentName}</div>
            </div>
            <div class="ai-assignment-metrics">
                <div class="ai-assignment-score">${assignment.score}/100</div>
                <div class="ai-assignment-time">${assignment.time}</div>
            </div>
        `;
        
        listContainer.insertBefore(assignmentElement, listContainer.firstChild);
        
        // Keep only last 10 assignments
        const assignments = listContainer.querySelectorAll('.ai-assignment-item');
        if (assignments.length > 10) {
            assignments[assignments.length - 1].remove();
        }
    }

    function viewAIInsights() {
        window.open('smart-lead-router-demo.html', '_blank');
    }

    function toggleAIMode() {
        aiModeEnabled = !aiModeEnabled;
        const toggleBtn = document.getElementById('ai-mode-toggle');
        
        if (aiModeEnabled) {
            toggleBtn.innerHTML = 'üü¢ AI Mode: ON';
            addActivityFeedItem('ü§ñ AI lead routing enabled', 'success');
        } else {
            toggleBtn.innerHTML = 'üî¥ AI Mode: OFF';
            addActivityFeedItem('‚ö†Ô∏è AI lead routing disabled - manual mode active', 'warning');
        }
    }

    // Predictive Analytics Functions
    function initializePredictiveAnalytics() {
        // Initialize with placeholder data
        updatePredictiveMetrics();
        
        // Update every 30 seconds
        setInterval(updatePredictiveMetrics, 30000);
    }

    async function loadPredictiveAnalytics() {
        try {
            addActivityFeedItem('üìä Loading predictive analytics...', 'info');
            
            // Remove loading state
            const loadingInsight = document.querySelector('.insight-item.loading');
            if (loadingInsight) {
                loadingInsight.remove();
            }
            
            // Get analytics insights
            const insights = await window.predictiveAnalytics.getDashboardInsights();
            
            // Update metrics
            updatePredictiveMetrics(insights);
            
            // Update insights
            updateAIInsights(insights);
            
            addActivityFeedItem('‚úÖ Predictive analytics loaded', 'success');
            
        } catch (error) {
            console.error('Failed to load predictive analytics:', error);
            addActivityFeedItem('‚ùå Failed to load predictive analytics', 'error');
        }
    }

    function updatePredictiveMetrics(insights = null) {
        if (insights) {
            // Update with real data
            const revenue = insights.revenue || {};
            const quality = insights.leadQuality || {};
            const risk = insights.churnRisk || {};
            const performance = insights.performance || {};
            
            document.getElementById('revenue-forecast').textContent = 
                '$' + (revenue.forecast || 85000).toLocaleString();
            document.getElementById('forecast-confidence').textContent = 
                `${Math.round((revenue.confidence || 0.95) * 100)}% confidence`;
                
            document.getElementById('hot-tier-count').textContent = quality.hot?.count || 0;
            document.getElementById('hot-tier-percent').textContent = quality.hot?.percent || '0%';
            
            document.getElementById('warm-tier-count').textContent = quality.warm?.count || 0;
            document.getElementById('warm-tier-percent').textContent = quality.warm?.percent || '0%';
            
            document.getElementById('cold-tier-count').textContent = quality.cold?.count || 0;
            document.getElementById('cold-tier-percent').textContent = quality.cold?.percent || '0%';
            
            document.getElementById('churn-risk').textContent = 
                risk.totalAtRisk || 0;
            document.getElementById('risk-urgency').textContent = 
                `${risk.totalAtRisk || 0} leads at risk`;
                
            const coachingNeeded = performance.individual?.filter(
                agent => agent.priority === 'high' || agent.priority === 'urgent'
            ).length || 0;
            document.getElementById('coaching-agents').textContent = coachingNeeded;
            document.getElementById('coaching-action').textContent = 
                `${coachingNeeded} agents need coaching`;
                
        } else {
            // Update with mock data
            document.getElementById('revenue-forecast').textContent = '$85,000';
            document.getElementById('forecast-confidence').textContent = '95% confidence';
            document.getElementById('hot-tier-count').textContent = '0';
            document.getElementById('hot-tier-percent').textContent = '0%';
            document.getElementById('warm-tier-count').textContent = '0';
            document.getElementById('warm-tier-percent').textContent = '0%';
            document.getElementById('cold-tier-count').textContent = '0';
            document.getElementById('cold-tier-percent').textContent = '0%';
            document.getElementById('churn-risk').textContent = '3';
            document.getElementById('risk-urgency').textContent = '3 leads at risk';
            document.getElementById('coaching-agents').textContent = '2';
            document.getElementById('coaching-action').textContent = '2 agents need coaching';
        }
    }

    function updateAIInsights(insights) {
        const insightsList = document.getElementById('performance-insights-list');
        insightsList.innerHTML = '';
        
        const allInsights = [
            ...insights.revenue?.insights || ['Revenue forecasting active'],
            ...insights.leadQuality?.recommendations?.map(r => r.action) || ['Lead quality analysis complete'],
            ...insights.churnRisk?.insights || ['Churn risk monitoring active']
        ];
        
        allInsights.slice(0, 5).forEach(insight => {
            const insightItem = document.createElement('div');
            insightItem.className = 'insight-item';
            insightItem.innerHTML = `
                <div class="insight-icon">üí°</div>
                <div class="insight-text">${insight}</div>
            `;
            insightsList.appendChild(insightItem);
        });
    }

    function openPredictiveDemo() {
        window.open('predictive-analytics-demo.html', '_blank');
    }

    async function generateForecast() {
        addActivityFeedItem('üìä Generating revenue forecast...', 'info');
        
        try {
            const forecast = await window.predictiveAnalytics.forecastRevenue('monthly');
            
            document.getElementById('revenue-forecast').textContent = 
                '$' + forecast.forecast.toLocaleString();
            document.getElementById('forecast-confidence').textContent = 
                `${Math.round(forecast.confidence * 100)}% confidence`;
            
            addActivityFeedItem(
                `‚úÖ Forecast generated: $${forecast.forecast.toLocaleString()} projected`,
                'success'
            );
        } catch (error) {
            addActivityFeedItem('‚ùå Forecast generation failed', 'error');
        }
    }

    async function analyzeRisk() {
        addActivityFeedItem('‚ö†Ô∏è Analyzing churn risk...', 'info');
        
        try {
            const riskAnalysis = await window.predictiveAnalytics.analyzeChurnRisk();
            
            document.getElementById('churn-risk').textContent = riskAnalysis.totalAtRisk;
            document.getElementById('risk-urgency').textContent = 
                `${riskAnalysis.totalAtRisk} leads at risk`;
            
            addActivityFeedItem(
                `‚úÖ Risk analysis complete: ${riskAnalysis.totalAtRisk} leads need attention`,
                riskAnalysis.totalAtRisk > 5 ? 'warning' : 'success'
            );
        } catch (error) {
            addActivityFeedItem('‚ùå Risk analysis failed', 'error');
        }
    }

    function addActivityFeedItem(message, type = 'info') {
        const feed = document.getElementById('activity-feed');
        
        const activity = document.createElement('div');
        activity.className = 'activity-item';
        activity.innerHTML = `
            <div class="activity-icon ${type}">
                ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
            </div>
            <div class="activity-content">
                <div class="activity-message">${message}</div>
                <div class="activity-time">${new Date().toLocaleTimeString()}</div>
            </div>
        `;
        
        feed.insertBefore(activity, feed.firstChild);
        
        // Keep only last 20 items
        const items = feed.querySelectorAll('.activity-item');
        if (items.length > 20) {
            items[items.length - 1].remove();
        }
    }

    // Initialize with some mock data
    setTimeout(() => {
        addActivityFeedItem('üöÄ Smart Lead Router system online', 'success');
        addActivityFeedItem('üìä AI metrics tracking started', 'info');
        addActivityFeedItem('üîÆ Predictive analytics initialized', 'info');
    }, 2000);

    // Navigation functions for admin dashboard
    function exportLeadData() {
        console.log('üìä Exporting lead data...');
        if (window.apiService) {
            window.apiService.exportLeads().then(data => {
                console.log('Export initiated:', data);
                addActivityFeedItem('üìä Lead export started', 'info');
            }).catch(error => {
                addActivityFeedItem('‚ùå Export failed', 'error');
            });
        }
    }

    function refreshOverview() {
        console.log('üîÑ Refreshing overview...');
        if (window.apiService) {
            window.apiService.getDashboardAnalytics().then(data => {
                console.log('Overview refreshed:', data);
                addActivityFeedItem('üîÑ Overview data refreshed', 'success');
            });
        }
    }

    function viewAvailableLeads() {
        console.log('üîç Viewing available leads...');
        // Could open a modal or navigate to leads view
        addActivityFeedItem('üëÅÔ∏è Viewing available leads', 'info');
    }

    function viewClaimedLeads() {
        console.log('üéØ Viewing claimed leads...');
        addActivityFeedItem('üëÅÔ∏è Viewing claimed leads', 'info');
    }

    function viewAgentPerformance() {
        console.log('üèÜ Viewing agent performance...');
        if (window.apiService) {
            window.apiService.getPerformanceMetrics().then(data => {
                console.log('Performance data:', data);
                addActivityFeedItem('üìä Agent performance loaded', 'info');
            });
        }
    }

    function showAnalyticsDetails() {
        console.log('üìà Opening analytics details...');
        window.open('predictive-analytics-demo.html', '_blank');
        addActivityFeedItem('üìà Analytics details opened', 'info');
    }

    function reassignLead() {
        console.log('üîÑ Reassigning lead...');
        // Would show lead reassignment modal
        addActivityFeedItem('üîÑ Lead reassignment initiated', 'info');
    }

    function bulkActions() {
        console.log('üì¶ Bulk actions...');
        // Would show bulk actions modal
        addActivityFeedItem('üì¶ Bulk actions opened', 'info');
    }

    function leadImport() {
        console.log('üì• Lead import...');
        // Would show import modal
        addActivityFeedItem('üì• Lead import started', 'info');
    }

    function agentDashboard() {
        console.log('üë§ Opening agent dashboard...');
        // Navigate to agent dashboard
        window.open('agent-dashboard.html', '_blank');
        addActivityFeedItem('üë§ Agent dashboard opened', 'info');
    }

    // MODAL CONTROL FUNCTIONS
    function openAddAgentModal() {
        console.log('üë§ Opening Add Agent modal...');
        const modal = document.getElementById('add-agent-modal');
        if (modal) {
            // Clear previous data
            document.getElementById('new-agent-email').value = '';
            document.getElementById('new-agent-role').value = 'agent';
            
            modal.classList.add('active');
            addActivityFeedItem('üë§ Add Agent dialog opened', 'info');
        }
    }

    function openAddPublisherModal() {
        console.log('üè¢ Opening Add Publisher modal...');
        const modal = document.getElementById('add-publisher-modal');
        if (modal) {
            // Clear and generate new data
            document.getElementById('new-publisher-name').value = '';
            document.getElementById('new-publisher-email').value = '';
            document.getElementById('new-publisher-code').value = generateVendorCode();
            document.getElementById('new-publisher-api-key').value = generateAPIKey();
            document.getElementById('new-publisher-status').value = 'active';
            
            modal.classList.add('active');
            addActivityFeedItem('üè¢ Add Publisher dialog opened', 'info');
        }
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('active');
        }
    }

    // ENHANCED MODAL FUNCTIONS
    function handleSendAgentInvite() {
        const email = document.getElementById('new-agent-email').value;
        const role = document.getElementById('new-agent-role').value;
        
        if (!email) {
            alert('Please enter an email address');
            return;
        }
        
        console.log('üìß Sending agent invite:', { email, role });
        
        // Here you would call your API to create the agent
        addActivityFeedItem(`üìß Agent invite sent to ${email}`, 'success');
        closeModal('add-agent-modal');
    }

    function handleCreatePublisher() {
        const name = document.getElementById('new-publisher-name').value;
        const email = document.getElementById('new-publisher-email').value;
        const vendorCode = document.getElementById('new-publisher-code').value;
        const apiKey = document.getElementById('new-publisher-api-key').value;
        const status = document.getElementById('new-publisher-status').value;
        
        if (!name || !email) {
            alert('Please fill in all required fields');
            return;
        }
        
        console.log('üè¢ Creating publisher:', { name, email, vendorCode, apiKey, status });
        
        // Here you would call your API to create the publisher
        addActivityFeedItem(`üè¢ Publisher "${name}" created successfully`, 'success');
        closeModal('add-publisher-modal');
    }
    </script>

    <!-- üîß ENHANCED MODAL FUNCTIONALITY -->
    <script>
    // Global helper functions
    function generateVendorCode() {
        const prefix = 'PUB';
        const timestamp = Date.now().toString().slice(-6);
        const random = Math.random().toString(36).substr(2, 4).toUpperCase();
        return `${prefix}${timestamp}${random}`;
    }
    
    function generateAPIKey() {
        return 'api_' + Math.random().toString(36).substr(2, 32);
    }

    // Ensure functions are available globally
    window.generateVendorCode = generateVendorCode;
    window.generateAPIKey = generateAPIKey;
    window.openAddAgentModal = openAddAgentModal;
    window.openAddPublisherModal = openAddPublisherModal;
    window.closeModal = closeModal;
    window.handleSendAgentInvite = handleSendAgentInvite;
    window.handleCreatePublisher = handleCreatePublisher;
    
    console.log('‚úÖ All modal functions are now globally accessible');
    </script>

    <!-- Additional AI Styling -->
    <style>
    .ai-badge {
        background: linear-gradient(45deg, var(--accent-purple), var(--accent-blue));
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius-md);
        font-size: var(--font-size-xs);
        font-weight: 600;
        margin-left: var(--space-2);
    }

    /* GLOBAL HELPER FUNCTIONS & FIXES */
    .btn-info {
        background: #3B82F6 !important;
        color: white;
        border: none;
    }

    .btn-info:hover {
        background: #2563EB !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    /* ENSURE MODALS WORK PROPERLY */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        z-index: 10000;
        align-items: center;
        justify-content: center;
    }

    .modal-overlay.active {
        display: flex !important;
    }

    .glass-modal {
        background: var(--bg-glass);
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        padding: 2rem 2rem 1rem;
        border-bottom: 1px solid var(--border-subtle);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        color: var(--text-primary);
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        color: var(--text-muted);
        font-size: 2rem;
        cursor: pointer;
        padding: 0;
        line-height: 1;
        transition: color var(--transition-base);
    }

    .modal-close:hover {
        color: var(--text-primary);
    }

    .modal-body {
        padding: 2rem;
    }

    .modal-footer {
        padding: 1rem 2rem 2rem;
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    /* RESPONSIVE MODAL */
    @media (max-width: 768px) {
        .glass-modal {
            width: 95%;
            margin: 1rem;
        }
        
        .modal-header,
        .modal-body,
        .modal-footer {
            padding: 1.5rem;
        }
        
        .modal-footer {
            flex-direction: column;
        }
        
        .modal-footer .btn {
            width: 100%;
        }
    }
    </style>
</body>
</html>
