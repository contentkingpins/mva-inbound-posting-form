<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claim Connectors - Publisher Integration Guide</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6; }
        .header { background: linear-gradient(135deg, #3B82F6, #8B5CF6); color: white; padding: 30px; border-radius: 10px; text-align: center; margin-bottom: 30px; }
        .section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3B82F6; }
        .code { background: #1e1e1e; color: #f8f8f2; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; overflow-x: auto; }
        .warning { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #3B82F6; color: white; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ Claim Connectors Publisher Integration</h1>
        <p>Welcome ${publisherName}! Your complete integration package</p>
    </div>

    <div class="section">
        <h2>üìã Your Publisher Credentials</h2>
        <table>
            <tr><th>Field</th><th>Value</th></tr>
            <tr><td>Publisher Name</td><td>${publisherName}</td></tr>
            <tr><td>Contact Email</td><td>${email}</td></tr>
            <tr><td>Vendor Code</td><td><strong>${vendorCode}</strong></td></tr>
            <tr><td>Tracking ID</td><td><strong>${trackingId}</strong></td></tr>
            <tr><td>API Key</td><td><strong>${apiKey}</strong></td></tr>
            <tr><td>API Endpoint</td><td>${baseUrl}</td></tr>
        </table>
        <div class="warning">
            <strong>‚ö†Ô∏è Important:</strong> Keep your API key secure and never share it publicly.
        </div>
    </div>

    <div class="section">
        <h2>üîó Lead Posting Instructions</h2>
        <p>To send leads to Claim Connectors, POST to our lead submission endpoint:</p>
        
        <h3>Endpoint:</h3>
        <div class="code">POST ${baseUrl}/leads</div>
        
        <h3>Headers Required:</h3>
        <div class="code">
Content-Type: application/json
X-API-Key: ${apiKey}
X-Vendor-Code: ${vendorCode}
        </div>
        
        <h3>Lead Data Format:</h3>
        <div class="code">
{
  "first_name": "John",
  "last_name": "Smith", 
  "email": "john.smith@email.com",
  "phone_home": "(555) 123-4567",
  "state": "CA",
  "incident_type": "auto_accident",
  "vendor_code": "${vendorCode}"
}
        </div>
    </div>

    <div class="success">
        <h3>‚úÖ Integration Complete!</h3>
        <p>Once implemented, leads will flow directly into our system.</p>
    </div>
</body>
</html>`;

        const apiDocs = `# Claim Connectors API Documentation

## Publisher: ${publisherName}
## Generated: ${new Date().toISOString()}

### Authentication
- **API Key:** ${apiKey}
- **Vendor Code:** ${vendorCode}

### Endpoints

#### Submit Lead
POST ${baseUrl}/leads
Content-Type: application/json
X-API-Key: ${apiKey}
X-Vendor-Code: ${vendorCode}

### Field Validation Rules
- **email**: Must be valid email format
- **phone_home**: US phone number format
- **state**: Must be valid US state code

### Rate Limits
- Maximum 100 requests per minute
- Maximum 10,000 leads per day

### Error Codes
- 400: Bad Request (validation error)
- 401: Unauthorized (invalid API key)
- 429: Rate limit exceeded
- 500: Internal server error`;

        const sampleCode = `// Claim Connectors Lead Submission - JavaScript Example
// Publisher: ${publisherName}

const CLAIM_CONNECTORS_CONFIG = {
    apiEndpoint: '${baseUrl}',
    apiKey: '${apiKey}',
    vendorCode: '${vendorCode}'
};

async function submitLead(leadData) {
    try {
        const response = await fetch(\`\${CLAIM_CONNECTORS_CONFIG.apiEndpoint}/leads\`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-API-Key': CLAIM_CONNECTORS_CONFIG.apiKey,
                'X-Vendor-Code': CLAIM_CONNECTORS_CONFIG.vendorCode
            },
            body: JSON.stringify({
                ...leadData,
                vendor_code: CLAIM_CONNECTORS_CONFIG.vendorCode,
                source: '${publisherName}'
            })
        });

        const result = await response.json();
        
        if (response.ok) {
            console.log('Lead submitted successfully:', result);
            return { success: true, data: result };
        } else {
            console.error('Lead submission failed:', result);
            return { success: false, error: result };
        }
    } catch (error) {
        console.error('Network error:', error);
        return { success: false, error: error.message };
    }
}`;

        const credentials = `CLAIM CONNECTORS PUBLISHER CREDENTIALS
=====================================

Publisher Name: ${publisherName}
Contact Email: ${email}
Vendor Code: ${vendorCode}
Tracking ID: ${trackingId}
API Key: ${apiKey}
API Endpoint: ${baseUrl}

IMPORTANT SECURITY NOTES:
- Never share your API key publicly
- Use HTTPS for all API requests  
- Store credentials securely
- Use your Tracking ID for traffic analytics

SUPPORT:
Email: publishers@claimconnectors.com
Phone: (555) CLAIM-01`;

        return {
            instructions,
            apiDocs,
            integrationGuide: "Complete integration guide and API documentation provided",
            sampleCode,
            credentials
        };
    }

    // Download publisher instructions as PDF
    function downloadPublisherInstructionsAsPdf(publisherName, email, vendorCode, apiKey) {
        const { jsPDF } = window.jspdf;
        const baseUrl = window.APP_CONFIG?.apiEndpoint || 'https://9qtb4my1ij.execute-api.us-east-1.amazonaws.com/prod';
        
        // Find the publisher to get the tracking ID
        const publisher = allPublishers.find(p => p.name === publisherName && p.email === email);
        const trackingId = publisher?.trackingId || 'Not Available';
        
        try {
            // Create a new PDF document
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            // Add header
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('Claim Connectors - API Integration', 20, 25);
            
            doc.setFontSize(16);
            doc.text(`Publisher: ${publisherName}`, 20, 35);
            
            // Add publisher credentials section
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Publisher Credentials', 20, 50);
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Publisher Name: ${publisherName}`, 25, 60);
            doc.text(`Contact Email: ${email}`, 25, 67);
            doc.text(`Vendor Code: ${vendorCode}`, 25, 74);
            doc.text(`Tracking ID: ${trackingId}`, 25, 81);
            doc.text(`API Key: ${apiKey}`, 25, 88);
            doc.text(`API Endpoint: ${baseUrl}`, 25, 95);
            
            // Add warning box
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text('‚ö†Ô∏è IMPORTANT: Keep your API key secure and never share it publicly.', 25, 105);
            
            // Add API instructions section
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Lead Submission Instructions', 20, 122);
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('To send leads to Claim Connectors, POST to our lead submission endpoint:', 25, 132);
            
            // Endpoint
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Endpoint:', 25, 142);
            doc.setFont(undefined, 'normal');
            doc.text(`POST ${baseUrl}/leads`, 25, 149);
            
            // Headers
            doc.setFont(undefined, 'bold');
            doc.text('Required Headers:', 25, 159);
            doc.setFont(undefined, 'normal');
            doc.text('Content-Type: application/json', 25, 166);
            doc.text(`X-API-Key: ${apiKey}`, 25, 173);
            doc.text(`X-Vendor-Code: ${vendorCode}`, 25, 180);
            
            // Sample payload
            doc.setFont(undefined, 'bold');
            doc.text('Sample Lead Data (Enhanced MVA Fields):', 25, 190);
            
            doc.setFont('courier', 'normal');
            doc.setFontSize(8);
            const samplePayload = [
                '{',
                '  "first_name": "John",',
                '  "last_name": "Smith",',
                '  "email": "john.smith@email.com",',
                '  "phone_home": "(555) 123-4567",',
                '  "state": "CA",',
                '  "zip": "90210",',
                `  "vendor_code": "${vendorCode}",`,
                '  "leadip": "192.168.1.100",',
                '  "source_url": "https://example.com/accident-form",',
                '  "xselect4": "campaign_name",',
                '  "posturl": "example.com",',
                '  "consent": "1",',
                '  "trustedform": "https://cert.trustedform.com/abc123",',
                '  "additional_details": "Rear-ended at red light",',
                '  "estimated_medical_bills": "$25,000 - $50,000",',
                '  "what_is_the_primary_injury": "Whiplash",',
                '  "did_the_injured_person_receive_treatment": "Treated at a hospital",',
                '  "are_you_currently_represented_by_a_lawyer_for_this_case": "No",',
                '  "was_a_police_report_filed": "Yes",',
                '  "_what_best_describes_the_type_of_accident_you_were_in": "Motor Vehicle",',
                '  "city_where_the_injury_occurred": "Los Angeles",',
                '  "when_did_the_accident_happen": "Within the last year",',
                '  "who_was_hurt_in_the_accident": "I was hurt",',
                '  "lead_source": "paid",',
                '  "provider_ip": "199.250.204.228"',
                '}'
            ];
            
            let yPos = 197;
            samplePayload.forEach(line => {
                doc.text(line, 25, yPos);
                yPos += 5;
            });
            
            // Add response format
            doc.setFont(undefined, 'bold');
            doc.setFontSize(10);
            doc.text('Success Response Format:', 25, yPos + 10);
            
            doc.setFont('courier', 'normal');
            doc.setFontSize(8);
            yPos += 17;
            const responseFormat = [
                '{',
                '  "status": "success",',
                '  "lead_id": "uuid-string",',
                '  "message": "Lead received"',
                '}'
            ];
            
            responseFormat.forEach(line => {
                doc.text(line, 25, yPos);
                yPos += 5;
            });
            
            // Add support information
            doc.setFont(undefined, 'bold');
            doc.setFontSize(10);
            doc.text('Support Contact:', 25, yPos + 15);
            doc.setFont(undefined, 'normal');
            doc.text('Email: publishers@claimconnectors.com', 25, yPos + 22);
            doc.text('Phone: (555) CLAIM-01', 25, yPos + 29);
            
            // Add footer
            doc.setFontSize(8);
            doc.setTextColor(128, 128, 128);
            doc.text(`Generated on: ${new Date().toLocaleString()}`, 20, 280);
            doc.text('Claim Connectors - Lead Management System', 20, 285);
            
            // Generate the PDF filename
            const filename = `${publisherName.replace(/[^a-zA-Z0-9]/g, '_')}_API_Instructions.pdf`;
            
            // Save the PDF
            doc.save(filename);
            
            console.log('‚úÖ Publisher PDF instructions downloaded successfully');
            
        } catch (err) {
            console.error('Failed to generate PDF: ', err);
            alert('Failed to generate PDF. Please try again.');
        }
    }

    // Expose functions to global scope immediately
    window.generateVendorCode = generateVendorCode;
    window.generateAPIKey = generateAPIKey;
    window.openAddAgentModal = openAddAgentModal;
    window.openAddPublisherModal = openAddPublisherModal;
    window.closeModal = closeModal;
    window.handleSendAgentInvite = handleSendAgentInvite;
    window.handleCreatePublisher = handleCreatePublisher;
    window.addActivityFeedItem = addActivityFeedItem;
    window.handleLogout = handleLogout;
    window.generatePublisherPackage = generatePublisherPackage;
    window.generatePublisherDocumentation = generatePublisherDocumentation;
    window.downloadPublisherInstructionsAsPdf = downloadPublisherInstructionsAsPdf;

    console.log('‚úÖ All modal functions are now globally accessible');
    
    // Add publisher management CSS styles
    const publisherCSS = `
        .publisher-management { margin-top: 2rem; }
        .publisher-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .publisher-filters { display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; }
        .filter-group { flex: 1; min-width: 200px; }
        .table-container { background: var(--bg-secondary); border-radius: var(--radius-lg); overflow: hidden; border: 1px solid var(--border-subtle); }
        .admin-table { width: 100%; border-collapse: collapse; }
        .admin-table th { background: var(--bg-accent); color: var(--text-primary); padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border-subtle); }
        .admin-table td { padding: 1rem; border-bottom: 1px solid var(--border-subtle); color: var(--text-primary); }
        .admin-table tr:hover { background: var(--bg-accent); }
        .publisher-info { display: flex; flex-direction: column; gap: 0.25rem; }
        .publisher-name { font-weight: 600; color: var(--text-primary); }
        .publisher-email { font-size: 0.875rem; color: var(--text-secondary); }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600; }
        .status-badge.active { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .status-badge.inactive { background: rgba(239, 68, 68, 0.2); color: var(--error); }
        .status-badge.pending { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .status-badge.suspended { background: rgba(139, 92, 246, 0.2); color: var(--accent-purple); }
        .vendor-code { font-family: 'Courier New', monospace; background: var(--bg-accent); padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.875rem; }
        .api-key-display { font-family: 'Courier New', monospace; background: var(--bg-accent); padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.875rem; max-width: 120px; overflow: hidden; text-overflow: ellipsis; }
        .api-key-display.no-key { color: var(--text-muted); background: transparent; }
        .action-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .action-btn-sm { padding: 0.25rem 0.5rem; border: none; border-radius: 0.25rem; font-size: 0.75rem; cursor: pointer; transition: all 0.2s ease; white-space: nowrap; }
        .action-btn-sm.view { background: var(--accent-blue); color: white; }
        .action-btn-sm.edit { background: var(--warning); color: white; }
        .action-btn-sm.pdf { background: var(--success); color: white; }
        .action-btn-sm.api { background: var(--accent-purple); color: white; }
        .action-btn-sm.toggle { background: var(--bg-accent); color: var(--text-primary); border: 1px solid var(--border-subtle); }
        .action-btn-sm.delete { background: var(--error); color: white; }
        .bulk-actions-bar { background: var(--bg-glass); backdrop-filter: blur(20px); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 1rem; margin-top: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .bulk-info { color: var(--text-primary); font-weight: 600; }
        .bulk-buttons { display: flex; gap: 0.5rem; }
        .publisher-count { background: var(--accent-purple); color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600; }
    `;
    
    const style = document.createElement('style');
    style.textContent = publisherCSS;
    document.head.appendChild(style);
    
    document.addEventListener('DOMContentLoaded', function() {
        // Handle modal close buttons
        document.querySelectorAll('.modal-close').forEach(closeBtn => {
            closeBtn.addEventListener('click', function() {
                const modal = this.closest('.modal-overlay');
                if (modal) {
                    modal.classList.remove('active');
                }
            });
        });
        
        // Handle FAB menu (simplified)
        const mainFab = document.getElementById('mainFab');
        if (mainFab) {
            mainFab.addEventListener('click', function() {
                document.querySelector('.fab-container').classList.toggle('active');
            });
        }
        
        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.classList.remove('active');
            }
        });
        
        // Update date and time
        function updateDateTime() {
            const now = new Date();
            const hour = now.getHours();
            let greeting = 'morning';
            
            if (hour >= 12 && hour < 17) greeting = 'afternoon';
            else if (hour >= 17) greeting = 'evening';
            
            const greetingEl = document.getElementById('time-greeting');
            const dateEl = document.getElementById('current-date');
            
            if (greetingEl) greetingEl.textContent = greeting;
            if (dateEl) {
                dateEl.textContent = now.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
        }
        
        updateDateTime();
        setInterval(updateDateTime, 60000); // Update every minute
        
        // Initialize with some mock data
        setTimeout(() => {
            addActivityFeedItem('System ready', 'success');
        }, 2000);
        
        console.log('üéØ Enhanced admin dashboard initialized');
    });

    // EXPANDABLE ACTIVITY FUNCTIONALITY
    function expandActivity(activityElement) {
        // Close all other expanded items
        document.querySelectorAll('.activity-item.expanded').forEach(item => {
            if (item !== activityElement) {
                item.classList.remove('expanded');
            }
        });
        
        // Toggle current item
        activityElement.classList.toggle('expanded');
    }

    // Expose expandActivity globally
    window.expandActivity = expandActivity;

    // Navigation functions for admin dashboard
    function exportLeadData() {
        console.log('üìä Exporting lead data...');
        addActivityFeedItem('üìä Lead export started', 'info');
    }

    function refreshOverview() {
        console.log('üîÑ Refreshing overview...');
        addActivityFeedItem('üîÑ Overview data refreshed', 'success');
    }

    function viewAvailableLeads() {
        console.log('üîç Viewing available leads...');
        addActivityFeedItem('üëÅÔ∏è Available leads view opened', 'info');
    }

    function viewClaimedLeads() {
        alert('Claimed Leads View - Coming Soon!');
        addActivityFeedItem('üëÅÔ∏è Claimed leads view opened', 'info');
    }

    function showAnalyticsDetails() {
        console.log('üìà Opening analytics details...');
        addActivityFeedItem('üìà Analytics feature temporarily disabled', 'info');
    }

    function reassignLead() {
        alert('Reassign Lead - Coming Soon!');
        addActivityFeedItem('üîÑ Lead reassignment opened', 'info');
    }

    function bulkActions() {
        console.log('üì¶ Opening bulk actions modal...');
        
        const bulkActionsModal = `
            <div class="modal-overlay active" id="bulk-actions-modal">
                <div class="modal glass-modal">
                    <div class="modal-header">
                        <h3 class="modal-title">üì¶ Bulk Lead Actions</h3>
                        <button class="modal-close" onclick="closeModal('bulk-actions-modal')">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="bulk-actions-grid">
                            <button class="bulk-action-btn" onclick="bulkReassignLeads()">
                                <span style="font-size: 2rem;">üîÑ</span>
                                <span>Reassign Leads</span>
                                <small>Reassign leads to different agents</small>
                            </button>
                            <button class="bulk-action-btn" onclick="bulkUpdateStatus()">
                                <span style="font-size: 2rem;">üìù</span>
                                <span>Update Status</span>
                                <small>Change lead status in bulk</small>
                            </button>
                            <button class="bulk-action-btn" onclick="bulkExportLeads()">
                                <span style="font-size: 2rem;">üìä</span>
                                <span>Export Leads</span>
                                <small>Download selected leads as CSV</small>
                            </button>
                            <button class="bulk-action-btn" onclick="bulkDeleteLeads()">
                                <span style="font-size: 2rem;">üóëÔ∏è</span>
                                <span>Delete Leads</span>
                                <small>Permanently remove leads</small>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', bulkActionsModal);
        addActivityFeedItem('üì¶ Bulk actions modal opened', 'info');
    }

    function agentDashboard() {
        console.log('üë§ Opening agent dashboard...');
        
        const agentDashboardModal = `
            <div class="modal-overlay active" id="agent-dashboard-modal">
                <div class="modal glass-modal" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3 class="modal-title">üë§ Agent Dashboard</h3>
                        <button class="modal-close" onclick="closeModal('agent-dashboard-modal')">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; color: var(--success);">24</div>
                                <div style="color: var(--text-secondary);">Total Agents</div>
                            </div>
                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; color: var(--accent-blue);">18</div>
                                <div style="color: var(--text-secondary);">Online Now</div>
                            </div>
                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; color: var(--warning);">156</div>
                                <div style="color: var(--text-secondary);">Active Leads</div>
                            </div>
                        </div>
                        <div class="management-actions">
                            <button class="action-btn" onclick="viewAgentPerformance()">
                                <span class="btn-icon">üìä</span>
                                <span class="btn-text">View Performance</span>
                            </button>
                            <button class="action-btn" onclick="manageAgentAccess()">
                                <span class="btn-icon">üîê</span>
                                <span class="btn-text">Manage Access</span>
                            </button>
                            <button class="action-btn" onclick="openAddAgentModal(); closeModal('agent-dashboard-modal')">
                                <span class="btn-icon">‚ûï</span>
                                <span class="btn-text">Add New Agent</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', agentDashboardModal);
        addActivityFeedItem('üë§ Agent dashboard opened', 'info');
    }

    function leadImport() {
        console.log('üì• Opening lead import modal...');
        
        const leadImportModal = `
            <div class="modal-overlay active" id="lead-import-modal">
                <div class="modal glass-modal">
                    <div class="modal-header">
                        <h3 class="modal-title">üì• Import Leads</h3>
                        <button class="modal-close" onclick="closeModal('lead-import-modal')">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <div style="font-size: 4rem; color: var(--accent-blue); margin-bottom: 1rem;">üìÑ</div>
                            <h4>Upload CSV File</h4>
                            <p style="color: var(--text-secondary);">Import leads from a CSV file. Maximum 1000 leads per upload.</p>
                        </div>
                        <div class="form-group">
                            <label>Select CSV File</label>
                            <input type="file" accept=".csv" class="form-input" id="lead-import-file">
                        </div>
                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                            <strong>Required CSV Format:</strong><br>
                            <code style="font-size: 0.8rem;">first_name,last_name,email,phone,state,incident_type</code>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal('lead-import-modal')">Cancel</button>
                            <button class="btn btn-primary" onclick="processLeadImport()">Upload & Import</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', leadImportModal);
        addActivityFeedItem('üì• Lead import modal opened', 'info');
    }

    // CHART MODAL FUNCTIONALITY
    function expandChart(type) {
        console.log(`üìä Expanding chart: ${type}`);
        addActivityFeedItem(`üìä Opened ${type} chart`, 'info');
        
        // For now, just show a simple message
        // In the future, this could open actual chart modals
        alert(`Chart view for "${type}" - Feature coming soon!`);
    }

    function closeChartModal() {
        console.log('‚ùå Closing chart modal');
        const modal = document.getElementById('chart-modal');
        if (modal) {
            modal.classList.remove('active');
        }
    }

    // Expose all functions globally
    window.expandChart = expandChart;
    window.closeChartModal = closeChartModal;

    // Publisher Management Functions
    let selectedPublishers = new Set();
    let allPublishers = [
        // Starting with empty array - no test data
    ];

    function loadPublishers() {
        renderPublishersTable();
        updatePublisherStats();
        updatePublisherCount();
    }

    function renderPublishersTable(publishers = allPublishers) {
        const tbody = document.getElementById('publishers-table-body');
        if (!tbody) return;

        tbody.innerHTML = publishers.map(publisher => `
            <tr>
                <td>
                    <input type="checkbox" onchange="togglePublisherSelection('${publisher.id}', this.checked)">
                </td>
                <td>
                    <div class="publisher-info">
                        <div class="publisher-name">${publisher.name}</div>
                        <div class="publisher-email">${publisher.email}</div>
                    </div>
                </td>
                <td>
                    <span class="status-badge ${publisher.status}">${publisher.status.toUpperCase()}</span>
                </td>
                <td>
                    <span class="vendor-code">${publisher.vendorCode}</span>
                </td>
                <td>
                    <span class="vendor-code">${publisher.trackingId || 'Not Generated'}</span>
                </td>
                <td>
                    <div class="api-key-display ${!publisher.apiKey ? 'no-key' : ''}">
                        ${publisher.apiKey ? publisher.apiKey.substring(0, 8) + '...' : 'No API Key'}
                    </div>
                </td>
                <td>${publisher.leads.toLocaleString()}</td>
                <td>$${publisher.revenue.toLocaleString()}</td>
                <td>${publisher.lastActivity ? formatTimeAgo(publisher.lastActivity) : 'Never'}</td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn-sm view" onclick="viewPublisher('${publisher.id}')" title="View Details">üëÅÔ∏è</button>
                        <button class="action-btn-sm edit" onclick="editPublisher('${publisher.id}')" title="Edit">‚úèÔ∏è</button>
                        <button class="action-btn-sm pdf" onclick="downloadPublisherPdf('${publisher.id}')" title="Download PDF">üìÑ</button>
                        ${publisher.apiKey ? 
                            `<button class="action-btn-sm api" onclick="regenerateApiKey('${publisher.id}')" title="Regenerate API">üîÑ</button>` :
                            `<button class="action-btn-sm api" onclick="generateApiKey('${publisher.id}')" title="Generate API">üîë</button>`
                        }
                        <button class="action-btn-sm toggle" onclick="togglePublisherStatus('${publisher.id}')" title="Toggle Status">
                            ${publisher.status === 'active' ? 'üî¥' : 'üü¢'}
                        </button>
                        <button class="action-btn-sm delete" onclick="deletePublisher('${publisher.id}')" title="Delete">üóëÔ∏è</button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    function updatePublisherStats() {
        const activePublishers = allPublishers.filter(p => p.status === 'active').length;
        const totalLeads = allPublishers.reduce((sum, p) => sum + p.leads, 0);
        const totalRevenue = allPublishers.reduce((sum, p) => sum + p.revenue, 0);

        document.getElementById('total-publishers').textContent = allPublishers.length;
        document.getElementById('active-publishers').textContent = activePublishers;
        document.getElementById('total-publisher-leads').textContent = totalLeads.toLocaleString();
        document.getElementById('total-publisher-revenue').textContent = '$' + totalRevenue.toLocaleString();
    }

    function updatePublisherCount() {
        const count = document.getElementById('publisher-count');
        if (count) {
            count.textContent = `${allPublishers.length} publishers`;
        }
    }

    function formatTimeAgo(dateString) {
        const now = new Date();
        const date = new Date(dateString);
        const diffInMinutes = Math.floor((now - date) / (1000 * 60));
        
        if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
        if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}h ago`;
        return `${Math.floor(diffInMinutes / 1440)}d ago`;
    }

    // Publisher Action Functions
    function viewPublisher(id) {
        const publisher = allPublishers.find(p => p.id === id);
        if (publisher) {
            alert(`Publisher Details:\n\nName: ${publisher.name}\nEmail: ${publisher.email}\nStatus: ${publisher.status}\nLeads: ${publisher.leads}\nRevenue: $${publisher.revenue}`);
        }
    }

    function editPublisher(id) {
        const publisher = allPublishers.find(p => p.id === id);
        if (publisher) {
            const newName = prompt('Edit Publisher Name:', publisher.name);
            if (newName && newName !== publisher.name) {
                publisher.name = newName;
                renderPublishersTable();
                addActivityFeedItem(`üìù Publisher "${newName}" updated`, 'info');
            }
        }
    }

    function downloadPublisherPdf(id) {
        const publisher = allPublishers.find(p => p.id === id);
        if (publisher && publisher.apiKey) {
            downloadPublisherInstructionsAsPdf(publisher.name, publisher.email, publisher.vendorCode, publisher.apiKey);
            addActivityFeedItem(`üìÑ PDF downloaded for ${publisher.name}`, 'success');
        } else {
            alert('No API key available for this publisher');
        }
    }

    function regenerateApiKey(id) {
        const publisher = allPublishers.find(p => p.id === id);
        if (publisher && confirm(`Regenerate API key for ${publisher.name}?`)) {
            publisher.apiKey = 'api_' + Math.random().toString(36).substr(2, 15);
            renderPublishersTable();
            addActivityFeedItem(`üîÑ API key regenerated for ${publisher.name}`, 'success');
        }
    }

    function generateApiKey(id) {
        const publisher = allPublishers.find(p => p.id === id);
        if (publisher) {
            publisher.apiKey = 'api_' + Math.random().toString(36).substr(2, 15);
            renderPublishersTable();
            addActivityFeedItem(`üîë API key generated for ${publisher.name}`, 'success');
        }
    }

    function togglePublisherStatus(id) {
        const publisher = allPublishers.find(p => p.id === id);
        if (publisher) {
            publisher.status = publisher.status === 'active' ? 'inactive' : 'active';
            renderPublishersTable();
            updatePublisherStats();
            addActivityFeedItem(`üîÑ ${publisher.name} status changed to ${publisher.status}`, 'info');
        }
    }

    function deletePublisher(id) {
        const publisher = allPublishers.find(p => p.id === id);
        if (publisher && confirm(`Delete publisher "${publisher.name}"?`)) {
            allPublishers = allPublishers.filter(p => p.id !== id);
            renderPublishersTable();
            updatePublisherStats();
            updatePublisherCount();
            addActivityFeedItem(`üóëÔ∏è Publisher "${publisher.name}" deleted`, 'warning');
        }
    }

    function togglePublisherSelection(id, checked) {
        if (checked) {
            selectedPublishers.add(id);
        } else {
            selectedPublishers.delete(id);
        }
        updateBulkActionsVisibility();
    }

    function toggleSelectAllPublishers() {
        const checkbox = document.getElementById('select-all-publishers');
        const allCheckboxes = document.querySelectorAll('#publishers-table-body input[type="checkbox"]');
        
        allCheckboxes.forEach(cb => {
            cb.checked = checkbox.checked;
            const id = cb.onchange.toString().match(/'([^']+)'/)[1];
            if (checkbox.checked) {
                selectedPublishers.add(id);
            } else {
                selectedPublishers.delete(id);
            }
        });
        updateBulkActionsVisibility();
    }

    function updateBulkActionsVisibility() {
        const bulkBar = document.getElementById('bulk-publishers-actions');
        const count = document.getElementById('selected-publishers-count');
        
        if (bulkBar && count) {
            bulkBar.style.display = selectedPublishers.size > 0 ? 'flex' : 'none';
            count.textContent = selectedPublishers.size;
        }
    }

    // Filter Functions
    function filterPublishers() {
        const search = document.getElementById('publisher-search').value.toLowerCase();
        const statusFilter = document.getElementById('publisher-status-filter').value;
        
        let filtered = allPublishers.filter(publisher => {
            const matchesSearch = publisher.name.toLowerCase().includes(search) || 
                                publisher.email.toLowerCase().includes(search);
            const matchesStatus = !statusFilter || publisher.status === statusFilter;
            return matchesSearch && matchesStatus;
        });

        renderPublishersTable(filtered);
    }

    function sortPublishers() {
        const sortBy = document.getElementById('publisher-sort').value;
        
        allPublishers.sort((a, b) => {
            switch(sortBy) {
                case 'name':
                    return a.name.localeCompare(b.name);
                case 'revenue':
                    return b.revenue - a.revenue;
                case 'leads':
                    return b.leads - a.leads;
                case 'created':
                    return new Date(b.lastActivity || 0) - new Date(a.lastActivity || 0);
                default:
                    return 0;
            }
        });
        
        renderPublishersTable();
    }

    // Bulk Actions
    function bulkActivatePublishers() {
        const selectedIds = Array.from(selectedPublishers);
        selectedIds.forEach(id => {
            const publisher = allPublishers.find(p => p.id === id);
            if (publisher) publisher.status = 'active';
        });
        renderPublishersTable();
        updatePublisherStats();
        selectedPublishers.clear();
        updateBulkActionsVisibility();
        addActivityFeedItem(`üü¢ ${selectedIds.length} publishers activated`, 'success');
    }

    function bulkDeactivatePublishers() {
        const selectedIds = Array.from(selectedPublishers);
        selectedIds.forEach(id => {
            const publisher = allPublishers.find(p => p.id === id);
            if (publisher) publisher.status = 'inactive';
        });
        renderPublishersTable();
        updatePublisherStats();
        selectedPublishers.clear();
        updateBulkActionsVisibility();
        addActivityFeedItem(`üî¥ ${selectedIds.length} publishers deactivated`, 'warning');
    }

    function bulkDownloadPdfs() {
        const selectedIds = Array.from(selectedPublishers);
        let downloadCount = 0;
        
        selectedIds.forEach(id => {
            const publisher = allPublishers.find(p => p.id === id);
            if (publisher && publisher.apiKey) {
                setTimeout(() => {
                    downloadPublisherInstructionsAsPdf(publisher.name, publisher.email, publisher.vendorCode, publisher.apiKey);
                }, downloadCount * 500);
                downloadCount++;
            }
        });
        
        if (downloadCount > 0) {
            addActivityFeedItem(`üìÑ ${downloadCount} PDFs downloaded`, 'success');
        } else {
            alert('No publishers with API keys selected');
        }
    }

    function bulkDeletePublishers() {
        const selectedIds = Array.from(selectedPublishers);
        if (confirm(`Delete ${selectedIds.length} selected publishers?`)) {
            allPublishers = allPublishers.filter(p => !selectedIds.includes(p.id));
            renderPublishersTable();
            updatePublisherStats();
            updatePublisherCount();
            selectedPublishers.clear();
            updateBulkActionsVisibility();
            addActivityFeedItem(`üóëÔ∏è ${selectedIds.length} publishers deleted`, 'warning');
        }
    }

    // Global Functions
    function refreshPublishers() {
        loadPublishers();
        addActivityFeedItem('üîÑ Publishers refreshed', 'info');
    }

    function exportPublishers() {
        const csvContent = "data:text/csv;charset=utf-8," + 
            "Name,Email,Vendor Code,Status,Leads,Revenue\n" +
            allPublishers.map(p => `"${p.name}","${p.email}","${p.vendorCode}","${p.status}",${p.leads},${p.revenue}`).join("\n");
        
        const link = document.createElement("a");
        link.setAttribute("href", encodeURI(csvContent));
        link.setAttribute("download", "publishers_export.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        addActivityFeedItem('üìä Publishers exported to CSV', 'success');
    }

    // Add event listeners for publisher filters
    setTimeout(() => {
        const searchInput = document.getElementById('publisher-search');
        const statusFilter = document.getElementById('publisher-status-filter');
        const sortSelect = document.getElementById('publisher-sort');
        
        if (searchInput) searchInput.addEventListener('input', filterPublishers);
        if (statusFilter) statusFilter.addEventListener('change', filterPublishers);
        if (sortSelect) sortSelect.addEventListener('change', sortPublishers);
        
        // Load initial data ONLY after DOM is ready
        console.log('üè¢ Loading initial publisher data...');
        loadPublishers();
        console.log('‚úÖ Publisher management initialized');
    }, 2000); // Increased delay to ensure DOM is fully ready

    // Expose publisher functions globally
    window.viewPublisher = viewPublisher;
    window.editPublisher = editPublisher;
    window.downloadPublisherPdf = downloadPublisherPdf;
    window.regenerateApiKey = regenerateApiKey;
    window.generateApiKey = generateApiKey;
    window.togglePublisherStatus = togglePublisherStatus;
    window.deletePublisher = deletePublisher;
    window.togglePublisherSelection = togglePublisherSelection;
    window.toggleSelectAllPublishers = toggleSelectAllPublishers;
    window.bulkActivatePublishers = bulkActivatePublishers;
    window.bulkDeactivatePublishers = bulkDeactivatePublishers;
    window.bulkDownloadPdfs = bulkDownloadPdfs;
    window.bulkDeletePublishers = bulkDeletePublishers;
    window.refreshPublishers = refreshPublishers;
    window.exportPublishers = exportPublishers;

    // Add missing bulk action functions
    function bulkReassignLeads() {
        alert('Bulk Reassign Leads - Coming Soon!');
        closeModal('bulk-actions-modal');
        addActivityFeedItem('üîÑ Bulk reassign initiated', 'info');
    }

    function bulkUpdateStatus() {
        alert('Bulk Update Status - Coming Soon!');
        closeModal('bulk-actions-modal');
        addActivityFeedItem('üìù Bulk status update initiated', 'info');
    }

    function bulkExportLeads() {
        alert('Bulk Export Leads - Coming Soon!');
        closeModal('bulk-actions-modal');
        addActivityFeedItem('üìä Bulk export initiated', 'success');
    }

    function bulkDeleteLeads() {
        if (confirm('Delete selected leads? This cannot be undone.')) {
            alert('Bulk Delete Leads - Coming Soon!');
            closeModal('bulk-actions-modal');
            addActivityFeedItem('üóëÔ∏è Bulk delete initiated', 'warning');
        }
    }

    function viewAgentPerformance() {
        alert('Agent Performance View - Coming Soon!');
        addActivityFeedItem('üìä Agent performance view opened', 'info');
    }

    function manageAgentAccess() {
        alert('Manage Agent Access - Coming Soon!');
        addActivityFeedItem('üîê Agent access management opened', 'info');
    }

    function processLeadImport() {
        const fileInput = document.getElementById('lead-import-file');
        if (!fileInput || !fileInput.files[0]) {
            alert('Please select a CSV file first');
            return;
        }
        
        alert(`Importing leads from: ${fileInput.files[0].name} - Coming Soon!`);
        closeModal('lead-import-modal');
        addActivityFeedItem('üì• Lead import processing...', 'info');
    }

    // Expose the new functions globally
    window.bulkActions = bulkActions;
    window.agentDashboard = agentDashboard;
    window.leadImport = leadImport;
    window.viewAvailableLeads = viewAvailableLeads;
    window.viewClaimedLeads = viewClaimedLeads;
    window.reassignLead = reassignLead;
    window.bulkReassignLeads = bulkReassignLeads;
    window.bulkUpdateStatus = bulkUpdateStatus;
    window.bulkExportLeads = bulkExportLeads;
    window.bulkDeleteLeads = bulkDeleteLeads;
    window.viewAgentPerformance = viewAgentPerformance;
    window.manageAgentAccess = manageAgentAccess;
    window.processLeadImport = processLeadImport;

    // Generate unique tracking ID for publisher traffic
    function generateTrackingId() {
        // Generate a unique 12-character tracking ID (TRK_XXXXXXXX)
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let trackingId = 'TRK_';
        for (let i = 0; i < 8; i++) {
            trackingId += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return trackingId;
    }

    </script>
</body>
</html>
