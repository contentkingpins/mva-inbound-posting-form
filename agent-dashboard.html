<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Dashboard - MVA CRM</title>
    
    <!-- MASTER DARK THEME -->
    <link rel="stylesheet" href="css/master-dark-theme.css">
    
    <!-- FALLBACK: Inline critical dark theme styles for instant loading -->
    <style>
    /* Critical dark theme styles - loads immediately */
    :root {
        --bg-primary: #0F0F23;
        --bg-secondary: #1A1A2E;
        --bg-accent: #16213E;
        --bg-glass: rgba(26, 26, 46, 0.95);
        --text-primary: #FFFFFF;
        --text-secondary: #CBD5E1;
        --text-muted: #9CA3AF;
        --accent-blue: #3B82F6;
        --accent-purple: #8B5CF6;
        --accent-cyan: #06B6D4;
        --success: #10B981;
        --warning: #F59E0B;
        --error: #EF4444;
        --info: #3B82F6;
        --border-subtle: rgba(139, 92, 246, 0.2);
        --border-accent: rgba(59, 130, 246, 0.3);
        --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5);
        --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.6);
        --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        --space-1: 0.25rem;
        --space-2: 0.5rem;
        --space-3: 0.75rem;
        --space-4: 1rem;
        --space-5: 1.25rem;
        --space-6: 1.5rem;
        --radius-md: 0.5rem;
        --radius-lg: 0.75rem;
        --radius-xl: 1rem;
        --transition-base: 0.3s ease;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
        font-family: var(--font-family);
        background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
        color: var(--text-primary);
        min-height: 100vh;
        line-height: 1.6;
        overflow-x: hidden;
    }
    
    /* Header Styling */
    .admin-header {
        background: var(--bg-glass);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--border-subtle);
        padding: var(--space-4) var(--space-6);
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: var(--shadow-lg);
    }
    
    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .header-title {
        color: var(--accent-purple);
        font-size: 1.5rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .header-greeting {
        color: var(--text-secondary);
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
    
    .header-stats {
        display: flex;
        gap: var(--space-4);
        margin-right: var(--space-4);
    }
    
    .stat-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--space-1);
    }
    
    .stat-label {
        color: var(--text-muted);
        font-size: 0.75rem;
    }
    
    .stat-value {
        color: var(--text-primary);
        font-weight: 600;
        font-size: 1.125rem;
    }
    
    /* Main Content */
    .admin-main {
        max-width: 1400px;
        margin: 0 auto;
        padding: var(--space-6);
        min-height: calc(100vh - 80px);
    }
    
    /* Glass Card Effects */
    .glass-card, .quick-actions, .content-section, .dashboard-content {
        background: var(--bg-glass);
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-lg);
        transition: all var(--transition-base);
    }
    
    .glass-card:hover {
        border-color: var(--border-accent);
        transform: translateY(-2px);
        box-shadow: var(--shadow-xl);
    }
    
    /* Quick Actions Grid */
    .actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: var(--space-4);
        margin-top: var(--space-4);
    }
    
    .action-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-5);
        background: var(--bg-secondary);
        border: 2px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        cursor: pointer;
        transition: all var(--transition-base);
        text-decoration: none;
        color: var(--text-primary);
    }
    
    .action-btn:hover {
        transform: translateY(-2px);
        border-color: var(--accent-blue);
        box-shadow: var(--shadow-lg);
    }
    
    .action-btn.primary { border-color: var(--accent-blue); }
    .action-btn.secondary { border-color: var(--accent-purple); }
    .action-btn.info { border-color: var(--info); }
    .action-btn.success { border-color: var(--success); }
    
    .action-icon { font-size: 1.875rem; }
    .action-text { font-weight: 600; font-size: 1.125rem; }
    .action-count { color: var(--text-muted); font-size: 0.875rem; }
    
    /* Buttons */
    .btn {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-3) var(--space-4);
        border: none;
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all var(--transition-base);
        text-decoration: none;
        white-space: nowrap;
    }
    
    .btn-primary {
        background: var(--accent-blue);
        color: white;
        box-shadow: var(--shadow-lg);
    }
    
    .btn-primary:hover {
        background: #2563EB;
        transform: translateY(-1px);
        box-shadow: var(--shadow-xl);
    }
    
    .btn-secondary {
        background: var(--bg-accent);
        color: var(--text-primary);
        border: 1px solid var(--border-subtle);
    }
    
    .btn-secondary:hover {
        background: var(--bg-secondary);
        border-color: var(--border-accent);
    }
    
    .btn-info {
        background: var(--info);
        color: white;
    }
    
    .btn-success {
        background: var(--success);
        color: white;
    }
    
    .btn-sm {
        padding: var(--space-2) var(--space-3);
        font-size: 0.75rem;
    }
    
    /* Form Elements */
    .search-input, .search-filter, .status-select, .form-input {
        background: var(--bg-secondary);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        padding: var(--space-3);
        color: var(--text-primary);
        font-size: 0.875rem;
        transition: all var(--transition-base);
    }
    
    .search-input:focus, .search-filter:focus, .status-select:focus, .form-input:focus {
        outline: none;
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }
    
    .search-input::placeholder {
        color: var(--text-muted);
    }
    
    /* Section Headers */
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-6);
        padding: 0 var(--space-2);
    }
    
    .section-header h3 {
        color: var(--text-primary);
        font-size: 1.25rem;
        font-weight: 600;
    }
    
    /* Lead Cards */
    .my-lead-card, .lead-card {
        background: var(--bg-primary);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        margin-bottom: var(--space-4);
        transition: all var(--transition-base);
    }
    
    .my-lead-card:hover, .lead-card:hover {
        border-color: var(--border-accent);
        transform: translateY(-1px);
        box-shadow: var(--shadow-lg);
    }
    
    .lead-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-3);
    }
    
    .lead-header h4 {
        color: var(--text-primary);
        font-size: 1.125rem;
        font-weight: 600;
    }
    
    /* Performance Cards */
    .performance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-4);
        margin-bottom: var(--space-6);
    }
    
    .performance-card {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        background: var(--bg-primary);
        padding: var(--space-4);
        border-radius: var(--radius-lg);
        border-left: 4px solid var(--accent-blue);
        box-shadow: var(--shadow-lg);
    }
    
    .perf-icon {
        font-size: 1.5rem;
        width: 50px;
        text-align: center;
    }
    
    .perf-label {
        color: var(--text-secondary);
        font-size: 0.875rem;
        margin-bottom: var(--space-1);
    }
    
    .perf-value {
        color: var(--text-primary);
        font-size: 1.25rem;
        font-weight: 700;
        margin-bottom: var(--space-1);
    }
    
    .perf-period {
        color: var(--text-muted);
        font-size: 0.75rem;
    }
    
    /* Quality Badges */
    .quality-badge {
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius-md);
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .quality-badge.premium {
        background: var(--success);
        color: white;
    }
    
    .quality-badge.standard {
        background: var(--accent-blue);
        color: white;
    }
    
    .quality-badge.basic {
        background: var(--warning);
        color: white;
    }
    
    /* Messages */
    .loading-message, .error-message, .no-results {
        text-align: center;
        padding: var(--space-6);
        color: var(--text-muted);
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-subtle);
    }
    
    .error-message {
        color: var(--error);
        border-color: var(--error);
    }
    
    /* Modal */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all var(--transition-base);
    }
    
    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    
    .modal {
        background: var(--bg-secondary);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        max-width: 800px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: var(--shadow-xl);
    }
    
    .modal-header {
        padding: var(--space-5);
        border-bottom: 1px solid var(--border-subtle);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-title {
        color: var(--text-primary);
        font-size: 1.25rem;
        font-weight: 600;
    }
    
    .modal-close {
        background: none;
        border: none;
        color: var(--text-muted);
        font-size: 1.5rem;
        cursor: pointer;
        padding: var(--space-1);
        border-radius: var(--radius-md);
        transition: all var(--transition-base);
    }
    
    .modal-close:hover {
        background: var(--bg-accent);
        color: var(--text-primary);
    }
    
    .modal-body {
        padding: var(--space-5);
    }
    
    .modal-footer {
        padding: var(--space-5);
        border-top: 1px solid var(--border-subtle);
        display: flex;
        gap: var(--space-3);
        justify-content: flex-end;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .actions-grid {
            grid-template-columns: 1fr;
        }
        
        .performance-grid {
            grid-template-columns: 1fr;
        }
        
        .header-content {
            flex-direction: column;
            gap: var(--space-3);
            align-items: stretch;
        }
        
        .header-stats {
            margin-right: 0;
            justify-content: center;
        }
        
        .section-header {
            flex-direction: column;
            align-items: stretch;
            gap: var(--space-3);
        }
        
        .modal {
            width: 95%;
            margin: var(--space-4);
        }
    }
    
    /* DISABLE ALL LIGHT MODE - FORCE DARK ALWAYS */
    body, html {
        color-scheme: dark !important;
    }
    
    /* Override any potential light mode styles */
    * {
        color-scheme: dark !important;
    }
    
    /* Ensure no light backgrounds ever appear */
    input, select, textarea, button {
        color-scheme: dark !important;
        background-color: var(--bg-secondary) !important;
        color: var(--text-primary) !important;
    }
    </style>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- 🎨 DARK THEME ENFORCER -->
    <script>
    // 🌙 PERMANENT DARK MODE ENFORCER - NO LIGHT MODE OPTIONS
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🎨 Agent Dashboard - PERMANENT Dark Theme Enforcer Active');
        
        // Force dark theme immediately and permanently
        document.body.classList.add('dark-theme');
        document.documentElement.classList.add('dark-theme');
        
        // Set CSS custom properties programmatically as backup
        const darkThemeVars = {
            '--bg-primary': '#0F0F23',
            '--bg-secondary': '#1A1A2E',
            '--bg-accent': '#16213E',
            '--bg-glass': 'rgba(26, 26, 46, 0.95)',
            '--text-primary': '#FFFFFF',
            '--text-secondary': '#CBD5E1',
            '--text-muted': '#9CA3AF',
            '--accent-blue': '#3B82F6',
            '--accent-purple': '#8B5CF6',
            '--success': '#10B981',
            '--warning': '#F59E0B',
            '--error': '#EF4444'
        };
        
        Object.entries(darkThemeVars).forEach(([property, value]) => {
            document.documentElement.style.setProperty(property, value);
        });
        
        // Force background and text color as absolute fallback
        document.body.style.cssText = `
            background: linear-gradient(135deg, #0F0F23 0%, #1A1A2E 100%) !important;
            color: #FFFFFF !important;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            min-height: 100vh !important;
        `;
        
        // Remove any potential light mode toggles or options
        const lightModeElements = document.querySelectorAll('[data-theme-toggle], .theme-switcher, .dark-mode-toggle, .light-mode-button');
        lightModeElements.forEach(el => el.remove());
        
        // Override any system preferences for color scheme
        if (window.matchMedia) {
            const mediaQuery = window.matchMedia('(prefers-color-scheme: light)');
            // Ignore system preference - always use dark
            mediaQuery.onchange = null;
        }
        
        // Prevent any CSS that might switch to light mode
        const preventLightMode = () => {
            const allElements = document.querySelectorAll('*');
            allElements.forEach(el => {
                if (el.style && el.style.backgroundColor === 'white' || el.style.backgroundColor === '#ffffff') {
                    el.style.backgroundColor = '#1A1A2E';
                }
                if (el.style && el.style.color === 'black' || el.style.color === '#000000') {
                    el.style.color = '#FFFFFF';
                }
            });
        };
        
        // Run immediately and on any DOM changes
        preventLightMode();
        
        // Watch for any dynamic content that might add light mode
        const observer = new MutationObserver(preventLightMode);
        observer.observe(document.body, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ['style', 'class']
        });
        
        console.log('✅ Agent Dashboard - PERMANENT dark theme enforced - NO light mode possible');
        console.log('🔒 Light mode options removed - Dark mode is PERMANENT');
    });
    
    // Additional protection against light mode
    window.addEventListener('load', function() {
        // Final check after everything loads
        setTimeout(() => {
            document.body.style.background = 'linear-gradient(135deg, #0F0F23 0%, #1A1A2E 100%)';
            document.body.style.color = '#FFFFFF';
            console.log('🛡️ Final dark theme protection applied');
        }, 1000);
    });
    </script>
</head>
<body>
    <!-- Header -->
    <header class="admin-header">
        <div class="header-content">
            <div class="header-left">
                <h1 class="header-title">
                    <span class="header-icon">👤</span>
                    Agent Dashboard
                </h1>
                <div class="header-greeting">
                    Welcome back, <span id="agent-name">Agent</span>
                </div>
            </div>
            <div class="header-right">
                <div class="header-stats">
                    <span class="stat-item">
                        <span class="stat-label">My Leads:</span>
                        <span class="stat-value" id="my-leads-count">0</span>
                    </span>
                    <span class="stat-item">
                        <span class="stat-label">Today:</span>
                        <span class="stat-value" id="todays-claims">0</span>
                    </span>
                </div>
                <button class="btn btn-secondary" onclick="refreshDashboard()">🔄 Refresh</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="admin-main">
        <!-- Quick Actions -->
        <section class="quick-actions glass-card">
            <h2>🚀 Quick Actions</h2>
            <div class="actions-grid">
                <button class="action-btn primary" onclick="showSearchLeads()">
                    <span class="action-icon">🔍</span>
                    <span class="action-text">Search Available Leads</span>
                    <span class="action-count" id="available-count">0 available</span>
                </button>
                
                <button class="action-btn secondary" onclick="showMyLeads()">
                    <span class="action-icon">📋</span>
                    <span class="action-text">My Claimed Leads</span>
                    <span class="action-count" id="claimed-count">0 claimed</span>
                </button>
                
                <button class="action-btn info" onclick="showPerformance()">
                    <span class="action-icon">📊</span>
                    <span class="action-text">My Performance</span>
                    <span class="action-count">This week</span>
                </button>
                
                <button class="action-btn success" onclick="showHelp()">
                    <span class="action-icon">❓</span>
                    <span class="action-text">Need Help?</span>
                    <span class="action-count">Guide & Tips</span>
                </button>
            </div>
        </section>

        <!-- Main Content Area -->
        <div class="dashboard-content">
            
            <!-- Search Available Leads -->
            <section class="content-section" id="search-section">
                <div class="section-header">
                    <h3>🔍 Search Available Leads</h3>
                    <div class="search-controls">
                        <form id="lead-search-form" class="search-form">
                            <input type="text" name="searchTerm" placeholder="Search by name, email, phone..." class="search-input">
                            <select name="state" class="search-filter">
                                <option value="">All States</option>
                                <option value="CA">California</option>
                                <option value="TX">Texas</option>
                                <option value="FL">Florida</option>
                                <option value="NY">New York</option>
                                <option value="IL">Illinois</option>
                            </select>
                            <select name="source" class="search-filter">
                                <option value="">All Sources</option>
                                <option value="website">Website</option>
                                <option value="referral">Referral</option>
                                <option value="google_ads">Google Ads</option>
                                <option value="facebook">Facebook</option>
                            </select>
                            <button type="submit" class="btn btn-primary">Search</button>
                        </form>
                    </div>
                </div>
                
                <div class="search-results" id="search-results">
                    <div class="loading-message">Click search to find available leads...</div>
                </div>
            </section>

            <!-- My Claimed Leads -->
            <section class="content-section" id="my-leads-section" style="display: none;">
                <div class="section-header">
                    <h3>📋 My Claimed Leads</h3>
                    <div class="leads-filters">
                        <select id="status-filter">
                            <option value="">All Status</option>
                            <option value="contacted">Contacted</option>
                            <option value="qualified">Qualified</option>
                            <option value="proposal">Proposal Sent</option>
                            <option value="closed">Closed</option>
                        </select>
                    </div>
                </div>
                
                <div class="my-leads-list" id="my-leads-list">
                    <div class="loading-message">Loading your leads...</div>
                </div>
            </section>

            <!-- Performance Section -->
            <section class="content-section" id="performance-section" style="display: none;">
                <div class="section-header">
                    <h3>📊 My Performance</h3>
                </div>
                
                <div class="performance-grid">
                    <div class="performance-card">
                        <div class="perf-icon">🎯</div>
                        <div class="perf-content">
                            <div class="perf-label">Leads Claimed</div>
                            <div class="perf-value" id="total-claimed">0</div>
                            <div class="perf-period">This week</div>
                        </div>
                    </div>
                    
                    <div class="performance-card">
                        <div class="perf-icon">📞</div>
                        <div class="perf-content">
                            <div class="perf-label">Contacts Made</div>
                            <div class="perf-value" id="total-contacts">0</div>
                            <div class="perf-period">This week</div>
                        </div>
                    </div>
                    
                    <div class="performance-card">
                        <div class="perf-icon">✅</div>
                        <div class="perf-content">
                            <div class="perf-label">Qualified Leads</div>
                            <div class="perf-value" id="total-qualified">0</div>
                            <div class="perf-period">This week</div>
                        </div>
                    </div>
                    
                    <div class="performance-card">
                        <div class="perf-icon">🏆</div>
                        <div class="perf-content">
                            <div class="perf-label">Success Rate</div>
                            <div class="perf-value" id="success-rate">0%</div>
                            <div class="perf-period">This week</div>
                        </div>
                    </div>
                </div>

                <div class="performance-insights">
                    <h4>🚀 Performance Insights</h4>
                    <div class="insights-list" id="performance-insights">
                        <div class="insight-item">Keep up the great work! Your response time is excellent.</div>
                    </div>
                </div>
            </section>

            <!-- Help Section -->
            <section class="content-section" id="help-section" style="display: none;">
                <div class="section-header">
                    <h3>❓ Help & Tips</h3>
                </div>
                
                <div class="help-content">
                    <div class="help-card">
                        <h4>🔍 How to Search for Leads</h4>
                        <ol>
                            <li>Use the search form to filter available leads</li>
                            <li>Look for high-quality leads (green badges)</li>
                            <li>Check urgency indicators for time-sensitive leads</li>
                            <li>Click "Claim This Lead" to take ownership</li>
                        </ol>
                    </div>
                    
                    <div class="help-card">
                        <h4>📋 Managing Your Leads</h4>
                        <ol>
                            <li>View all your claimed leads in "My Leads"</li>
                            <li>Update lead status as you progress</li>
                            <li>Add notes to track conversations</li>
                            <li>Use quick actions for common tasks</li>
                        </ol>
                    </div>
                    
                    <div class="help-card">
                        <h4>🏆 Best Practices</h4>
                        <ul>
                            <li>Respond to hot leads within 15 minutes</li>
                            <li>Update lead status after each interaction</li>
                            <li>Add detailed notes for follow-up</li>
                            <li>Focus on high-quality, urgent leads first</li>
                        </ul>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Lead Details Modal -->
    <div class="modal-overlay" id="lead-details-modal">
        <div class="modal glass-modal large-modal">
            <div class="modal-header">
                <h3 class="modal-title" id="lead-modal-title">Lead Details</h3>
                <button class="modal-close" onclick="closeLeadModal()">&times;</button>
            </div>
            <div class="modal-body" id="lead-modal-body">
                <!-- Lead details will be populated -->
            </div>
            <div class="modal-footer" id="lead-modal-footer">
                <!-- Action buttons will be populated -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/predictive-analytics.js"></script>
    <script src="js/lead-management.js"></script>
    <script src="js/api-service.js"></script>
    
    <script>
    let currentSection = 'search';
    
    document.addEventListener('DOMContentLoaded', function() {
        initializeAgentDashboard();
    });

    async function initializeAgentDashboard() {
        console.log('🎯 Initializing Agent Dashboard');
        
        // Load agent info
        await loadAgentInfo();
        
        // Load initial counts
        await updateCounts();
        
        // Set up event listeners
        setupEventListeners();
        
        // Show default section
        showSearchLeads();
        
        console.log('✅ Agent Dashboard ready');
    }

    async function loadAgentInfo() {
        // In production, load from session/API
        const agentName = sessionStorage.getItem('agentName') || 'Agent';
        document.getElementById('agent-name').textContent = agentName;
    }

    async function updateCounts() {
        try {
            // Get counts from lead management system
            if (window.leadManagement) {
                const myLeads = await window.leadManagement.getMyLeads();
                document.getElementById('my-leads-count').textContent = myLeads.length;
                document.getElementById('claimed-count').textContent = myLeads.length + ' claimed';
                
                // Calculate today's claims
                const today = new Date().toDateString();
                const todaysClaims = myLeads.filter(lead => 
                    new Date(lead.claimedAt).toDateString() === today
                ).length;
                document.getElementById('todays-claims').textContent = todaysClaims;
            }
        } catch (error) {
            console.error('Failed to update counts:', error);
        }
    }

    function setupEventListeners() {
        // Search form
        const searchForm = document.getElementById('lead-search-form');
        if (searchForm) {
            searchForm.addEventListener('submit', handleSearch);
        }

        // Status filter for my leads
        const statusFilter = document.getElementById('status-filter');
        if (statusFilter) {
            statusFilter.addEventListener('change', filterMyLeads);
        }
    }

    async function handleSearch(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const filters = Object.fromEntries(formData.entries());
        
        console.log('🔍 Searching with filters:', filters);
        
        // Show loading
        document.getElementById('search-results').innerHTML = '<div class="loading-message">Searching for leads...</div>';
        
        try {
            if (window.leadManagement) {
                await window.leadManagement.searchLeads(filters);
                updateAvailableCount();
            }
        } catch (error) {
            console.error('Search failed:', error);
            document.getElementById('search-results').innerHTML = '<div class="error-message">Search failed. Please try again.</div>';
        }
    }

    async function updateAvailableCount() {
        if (window.leadManagement) {
            const availableCount = window.leadManagement.availableLeads.size;
            document.getElementById('available-count').textContent = availableCount + ' available';
        }
    }

    // Navigation functions
    function showSearchLeads() {
        switchSection('search-section');
        currentSection = 'search';
        
        // Trigger search to show available leads
        if (window.leadManagement) {
            window.leadManagement.searchLeads();
        }
    }

    async function showMyLeads() {
        switchSection('my-leads-section');
        currentSection = 'my-leads';
        
        await loadMyLeads();
    }

    function showPerformance() {
        switchSection('performance-section');
        currentSection = 'performance';
        
        loadPerformanceData();
    }

    function showHelp() {
        switchSection('help-section');
        currentSection = 'help';
    }

    function switchSection(sectionId) {
        // Hide all sections
        document.querySelectorAll('.content-section').forEach(section => {
            section.style.display = 'none';
        });
        
        // Show target section
        document.getElementById(sectionId).style.display = 'block';
        
        // Update button states
        document.querySelectorAll('.action-btn').forEach(btn => {
            btn.classList.remove('active');
        });
    }

    async function loadMyLeads() {
        const container = document.getElementById('my-leads-list');
        container.innerHTML = '<div class="loading-message">Loading your leads...</div>';
        
        try {
            if (window.leadManagement) {
                const myLeads = await window.leadManagement.getMyLeads();
                displayMyLeads(myLeads);
            }
        } catch (error) {
            console.error('Failed to load my leads:', error);
            container.innerHTML = '<div class="error-message">Failed to load leads.</div>';
        }
    }

    function displayMyLeads(leads) {
        const container = document.getElementById('my-leads-list');
        
        if (leads.length === 0) {
            container.innerHTML = '<div class="no-results">You haven\'t claimed any leads yet. Search for available leads to get started!</div>';
            return;
        }
        
        container.innerHTML = '';
        
        leads.forEach(lead => {
            const leadCard = createMyLeadCard(lead);
            container.appendChild(leadCard);
        });
    }

    function createMyLeadCard(lead) {
        const card = document.createElement('div');
        card.className = `my-lead-card ${lead.status || 'claimed'}`;
        card.innerHTML = `
            <div class="lead-header">
                <h4>${lead.firstName} ${lead.lastName}</h4>
                <div class="lead-status">
                    <select class="status-select" onchange="updateLeadStatus('${lead.id}', this.value)">
                        <option value="claimed" ${lead.status === 'claimed' ? 'selected' : ''}>Claimed</option>
                        <option value="contacted" ${lead.status === 'contacted' ? 'selected' : ''}>Contacted</option>
                        <option value="qualified" ${lead.status === 'qualified' ? 'selected' : ''}>Qualified</option>
                        <option value="proposal" ${lead.status === 'proposal' ? 'selected' : ''}>Proposal Sent</option>
                        <option value="closed" ${lead.status === 'closed' ? 'selected' : ''}>Closed</option>
                    </select>
                </div>
            </div>
            <div class="lead-details">
                <div class="detail-row">
                    <span>📍 ${lead.city}, ${lead.state}</span>
                    <span>📧 ${lead.email}</span>
                </div>
                <div class="detail-row">
                    <span>📞 ${lead.phone}</span>
                    <span>📅 Created: ${new Date(lead.createdAt).toLocaleDateString()}</span>
                </div>
                <div class="detail-row">
                    <span>📅 Claimed: ${new Date(lead.claimedAt).toLocaleDateString()}</span>
                    <span class="quality-badge ${lead.tier}">${lead.qualityScore}/100</span>
                </div>
            </div>
            <div class="lead-actions">
                <button class="btn btn-primary btn-sm" onclick="callLead('${lead.phone}')">
                    📞 Call
                </button>
                <button class="btn btn-secondary btn-sm" onclick="emailLead('${lead.email}')">
                    ✉️ Email
                </button>
                <button class="btn btn-info btn-sm" onclick="viewLeadDetails('${lead.id}')">
                    👁️ Details
                </button>
                <button class="btn btn-success btn-sm" onclick="addLeadNote('${lead.id}')">
                    📝 Note
                </button>
            </div>
        `;
        
        return card;
    }

    async function updateLeadStatus(leadId, newStatus) {
        if (window.leadManagement) {
            const success = await window.leadManagement.updateLeadStatus(leadId, newStatus);
            if (success) {
                // Optionally reload the leads or just update UI
                console.log('✅ Status updated successfully');
                await updateCounts();
            }
        }
    }

    function loadPerformanceData() {
        // Load performance metrics (NO REVENUE - ADMIN ONLY)
        const mockData = {
            totalClaimed: 12,
            totalContacts: 8,
            totalQualified: 5,
            successRate: 62 // percentage of contacted leads that converted
        };
        
        document.getElementById('total-claimed').textContent = mockData.totalClaimed;
        document.getElementById('total-contacts').textContent = mockData.totalContacts;
        document.getElementById('total-qualified').textContent = mockData.totalQualified;
        document.getElementById('success-rate').textContent = mockData.successRate + '%';
    }

    // Action functions
    function callLead(phone) {
        window.open(`tel:${phone}`);
    }

    function emailLead(email) {
        window.open(`mailto:${email}`);
    }

    function viewLeadDetails(leadId) {
        console.log('👁️ Viewing lead details:', leadId);
        // Would open lead details modal
        if (window.leadManagement) {
            window.leadManagement.viewLeadDetails(leadId);
        }
    }

    async function addLeadNote(leadId) {
        const note = prompt('Add a note for this lead:');
        if (note && window.leadManagement) {
            await window.leadManagement.addLeadNote(leadId, note);
        }
    }

    async function refreshDashboard() {
        console.log('🔄 Refreshing dashboard...');
        await updateCounts();
        
        if (currentSection === 'search') {
            showSearchLeads();
        } else if (currentSection === 'my-leads') {
            await loadMyLeads();
        } else if (currentSection === 'performance') {
            loadPerformanceData();
        }
    }

    function filterMyLeads() {
        // Filter implementation would go here
        console.log('Filtering my leads...');
    }

    function closeLeadModal() {
        document.getElementById('lead-details-modal').classList.remove('active');
    }
    </script>

    <!-- Agent Dashboard Specific Styles -->
    <style>
    .quick-actions {
        margin-bottom: var(--space-6);
        padding: var(--space-5);
    }

    .actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: var(--space-4);
        margin-top: var(--space-4);
    }

    .action-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-5);
        background: var(--bg-secondary);
        border: 2px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        color: var(--text-primary);
    }

    .action-btn:hover {
        transform: translateY(-2px);
        border-color: var(--accent-blue);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    .action-btn.primary { border-color: var(--accent-blue); }
    .action-btn.secondary { border-color: var(--accent-purple); }
    .action-btn.info { border-color: var(--info); }
    .action-btn.success { border-color: var(--success); }

    .action-icon {
        font-size: var(--font-size-3xl);
    }

    .action-text {
        font-weight: 600;
        font-size: var(--font-size-lg);
    }

    .action-count {
        color: var(--text-muted);
        font-size: var(--font-size-sm);
    }

    .dashboard-content {
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-6);
    }

    .content-section {
        padding: var(--space-6);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-6);
    }

    .search-form {
        display: flex;
        gap: var(--space-3);
        align-items: center;
    }

    .search-input {
        min-width: 250px;
    }

    .header-stats {
        display: flex;
        gap: var(--space-4);
        margin-right: var(--space-4);
    }

    .stat-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--space-1);
    }

    .stat-label {
        color: var(--text-muted);
        font-size: var(--font-size-xs);
    }

    .stat-value {
        color: var(--text-primary);
        font-weight: 600;
        font-size: var(--font-size-lg);
    }

    .my-lead-card {
        background: var(--bg-primary);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        margin-bottom: var(--space-4);
    }

    .lead-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-3);
    }

    .status-select {
        background: var(--bg-secondary);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        padding: var(--space-1) var(--space-2);
        color: var(--text-primary);
    }

    .performance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-4);
        margin-bottom: var(--space-6);
    }

    .performance-card {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        background: var(--bg-primary);
        padding: var(--space-4);
        border-radius: var(--radius-lg);
        border-left: 4px solid var(--accent-blue);
    }

    .perf-icon {
        font-size: var(--font-size-2xl);
        width: 50px;
        text-align: center;
    }

    .perf-label {
        color: var(--text-secondary);
        font-size: var(--font-size-sm);
        margin-bottom: var(--space-1);
    }

    .perf-value {
        color: var(--text-primary);
        font-size: var(--font-size-xl);
        font-weight: 700;
        margin-bottom: var(--space-1);
    }

    .perf-period {
        color: var(--text-muted);
        font-size: var(--font-size-xs);
    }

    .performance-insights {
        background: var(--bg-primary);
        padding: var(--space-4);
        border-radius: var(--radius-lg);
    }

    .insights-list {
        margin-top: var(--space-3);
    }

    .insight-item {
        padding: var(--space-2);
        background: var(--bg-accent);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        margin-bottom: var(--space-2);
    }

    .help-content {
        display: grid;
        gap: var(--space-4);
    }

    .help-card {
        background: var(--bg-primary);
        padding: var(--space-4);
        border-radius: var(--radius-lg);
        border-left: 4px solid var(--accent-purple);
    }

    .help-card h4 {
        margin-bottom: var(--space-3);
        color: var(--text-primary);
    }

    .help-card ol, .help-card ul {
        margin-left: var(--space-4);
        color: var(--text-secondary);
    }

    .help-card li {
        margin-bottom: var(--space-1);
    }

    .loading-message, .error-message, .no-results {
        text-align: center;
        padding: var(--space-6);
        color: var(--text-muted);
    }

    .error-message {
        color: var(--error);
    }

    .large-modal .modal {
        max-width: 800px;
    }

    @media (max-width: 768px) {
        .actions-grid {
            grid-template-columns: 1fr;
        }
        
        .search-form {
            flex-direction: column;
            align-items: stretch;
        }
        
        .search-input {
            min-width: auto;
        }
        
        .section-header {
            flex-direction: column;
            align-items: stretch;
            gap: var(--space-3);
        }
        
        .performance-grid {
            grid-template-columns: 1fr;
        }
        
        .header-stats {
            margin-right: 0;
            margin-bottom: var(--space-2);
        }
    }
    </style>
</body>
</html> 